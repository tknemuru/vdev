# system docs 読み込み最適化レポート

**作成日**: 2026-02-05
**目的**: 各コマンドが毎回読み込む3つのsystem docs（architecture.md, domain-model.md, api-overview.md）の必要性を精査し、不要な読み込みを削減

---

## 1. 背景

vdevフローでは、多くのコマンドがStep初期に3つのsystem docsを一括で読み込む設計になっている。本来はコードベース調査の効率化を目的とした設計だが、コマンドによっては実際に参照されないケースがあり、トークンの無駄遣いになっている可能性がある。

## 2. system docs のサイズ

実プロジェクトでの計測結果:

| プロジェクト | architecture.md | domain-model.md | api-overview.md | 合計 |
|---|---|---|---|---|
| dre | 345行 | 281行 | 297行 | 923行 |
| abel | 248行 | 150行 | 151行 | 549行 |
| Reluca | 151行 | 213行 | なし | 364行 |

大きいプロジェクト（dre）では3ファイルで約923行、推定2,500〜4,000トークン。

## 3. コマンド別の必要性分析

### system docs が必須なコマンド

| コマンド | 理由 |
|---|---|
| `/rfc` | 新規設計の起草に全体像が不可欠。system docsへの影響判断がDoDに含まれる |
| `/imp` | タスク策定に構造・データ情報が必須。「コードベースの追加調査は行わない」と明記されており、system docsが唯一の構造情報源 |

### system docs が不要なコマンド

| コマンド | 理由 |
|---|---|
| `/urfc` | RFC修正はRFC本文 + レビュー結果で完結する。レビュー指摘はRFC内の論理的整合性に関するものが大半 |
| `/uimp` | コード修正はRFC + レビュー結果 + 対象コードファイルで完結する。具体的コード修正にsystem docsは不要 |
| `/upr` | PRコメント対応はRFC + diff + PRコメント自体がコンテキストとして十分。コメントは具体的コード箇所への指摘 |

### system docs を読み込まないコマンド（変更不要）

| コマンド | 備考 |
|---|---|
| `/rrfc` | レビュアーはRFC本文のみ読む。元々system docsは読み込み対象外 |
| `/rimp` | レビュアーはRFC + diffのみ読む。元々system docsは読み込み対象外 |
| `/consult` | オンデマンド読み取り。元々system docsは読み込み対象外 |

## 4. 削減効果の試算

### 1サイクルあたりの読み込み回数

| | 変更前 | 変更後 | 削減 |
|---|---|---|---|
| system docs読み込み回数 | 5回（rfc, urfc, imp, uimp, upr） | 2回（rfc, imp） | 3回分削減 |

### dreプロジェクト（最大ケース）での試算

| | 変更前 | 変更後 | 削減 |
|---|---|---|---|
| 読み込み行数 | 5回 x 923行 = 4,615行 | 2回 x 923行 = 1,846行 | 2,769行（60%削減） |
| 推定トークン | 12,500〜20,000 | 5,000〜8,000 | 約7,500〜12,000トークン/サイクル |

## 5. 品質への影響

system docsを読まなくても品質が落ちない根拠:

- **`/urfc`**: レビュー指摘は「RFCの中の問題」であり、修正もRFCの中で完結する。レビュアーがsystem docsとの整合性を指摘した場合でも、指摘文中に具体的な内容が引用されている
- **`/uimp`**: レビュー指摘は具体的なコード箇所+問題+修正案がセットで記述されている
- **`/upr`**: PRコメントはさらに具体的（行番号付きインラインコメント等）

万が一修正作業中にsystem docsの情報が必要になった場合、Claudeは自らファイルを読む能力があるため自発的に読みにいける。「最初に全部読んでおく」から「必要になったら読む」への切り替え。

## 6. 適用した変更

以下の3コマンドからsystem docs（architecture.md, domain-model.md, api-overview.md）の読み込み指示を削除:

- `adapters/claude/commands/urfc.md` — Step 3 のタイトルと読み込みリストを変更
- `adapters/claude/commands/uimp.md` — Step 3 のタイトルと読み込みリストを変更
- `adapters/claude/commands/upr.md` — Step 4 のタイトルと読み込みリストを変更

`/rfc` と `/imp` は変更なし（system docs読み込みを維持）。

## 7. 参考資料

- [claude-mem 導入評価レポート](20260205-claude-mem-evaluation.md) — トークン削減策の全体的な検討
- [レビュアーモデル切り替え評価レポート](20260205-reviewer-model-switching.md) — 別のトークン削減アプローチ
