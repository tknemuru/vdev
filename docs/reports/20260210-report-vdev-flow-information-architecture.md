# vdev フロー改善分析: 情報アーキテクチャの再設計

- 作成日: 2026-02-10
- 種別: report
- 対象: vdev の RFC-driven development workflow 全体

## 1. 背景

abel リポジトリの RFC 5-1（Paper Trading 検証）作成時に重大な設計ミスが6件発生し、PR レビューで全面的な書き直しが必要になった（詳細は abel リポジトリの `20260208-report-rfc-quality-analysis.md` を参照）。

同報告書はインプット情報（`docs/ops.md` 等）の不備を根本原因として特定したが、本レポートでは **vdev 側のフロー設計にも構造的な改善ポイントがある** という仮説のもと、ワークフロー全体を分析した。

さらに、abel の retrain インシデント（abel リポジトリの `20260210-report-retrain-unfiltered-scraping-incident.md`）も分析対象に含め、RFC 品質問題と合わせてより広い視点から問題の構造を考察した。

## 2. 分析対象の事象

### 2.1 RFC 5-1 の設計ミス（6件）

| # | エラー内容 | 分類 |
|---|-----------|------|
| 1 | Paper Trading が既存の `ipat.dev: true` で実現済みなのに新規設計した | 技術的事実の誤認 |
| 2 | 購入パイプラインをポーリング常駐と誤認（実際はワンショット） | 技術的事実の誤認 |
| 3 | 全レース一括処理で問題なしと認識（発走直前のオッズ取得が必須） | ドメイン知識の欠如 |
| 4 | 人間が手動実行する運用を提案（完全自動運用が必須） | ドメイン知識の欠如 |
| 5 | 再学習をスコープ外と扱った（スコープに含めるべき） | ドメイン知識の欠如 |
| 6 | 対象競馬種別・開催曜日が不明確（中央競馬・土日のみ） | ドメイン知識の欠如 |

### 2.2 retrain インシデント

`retrain.sh` の Step 1 が `result-set-register` を引数なしで呼び出し、`yearFrom=null` / `yearTo=null`（制限なし）で netkeiba.com に対して約85分間・1,576件のスクレイピングを実行した。

AI は `result-set-register` の挙動を正しくコードから理解できたはずだが、**引数なしで外部スクレイピングを呼び出した場合の運用上の帰結を想像しなかった**。これは技術的事実の誤認ではなく、プロジェクト固有の行動原則（外部アクセスに対する慎重さ）が AI に伝達されていなかったことが原因である。

## 3. 段階的な分析の経緯

### 3.1 第一段階: 局所的な改善案（棄却）

最初に以下の改善案を検討した。

- `/rfc` Step 5 のコードベース調査に具体的な手順を追加
- Approach Reviewer にファクトチェック責務を追加
- `/rfc` にコード調査後の「事実確認ヒアリング」ステップを追加
- `/arfc` に人間の中間レビューゲートを追加

これらは **ルール追記型** のアプローチであり、以下の理由で棄却した。

- 今回の特定の問題にのみ対処する局所解である
- 将来、異なる種類の問題が発生するたびにコマンドやロールへの追記が必要になる
- 命令文の肥大化・煩雑化を招き、メンテナンス性が低下する
- `/arfc` への人間ゲート追加は自動化のメリットを完全に毀損する

### 3.2 第二段階: 情報フローのボトルネック分析

次に、ワークフローの情報フローに注目した。

```
Stage 1 (Drafting):
  入力: 元ネタ + System Overview Docs + Codebase
  処理: RFC Author が調査・理解・設計をすべて行う
  出力: RFC ドキュメント

Stage 2 (Reviewing):
  入力: RFC ドキュメントのみ  ← ボトルネック
  処理: 3 Reviewers が RFC を評価
  出力: レビュー結果
```

**レビュアーは RFC ドキュメントしか見ておらず、コードベースに独立してアクセスしない。** Author の理解が間違っていた場合、RFC の内的整合性はパスするが、事実との整合性は誰もチェックしていない構造的な単一障害点を特定した。

この分析に基づき「RFC テンプレートに現状分析セクションを追加」「Approach Reviewer にコードベースアクセスを付与」を提案したが、依然として既存フローの延長線上にある中途半端な解決策であった。

### 3.3 第三段階: System Overview Docs の役割問題

さらに深掘りし、System Overview Docs に混在する2種類の情報の本質的な違いに着目した。

| 種類 | 例 | 真実のソース | 陳腐化リスク |
|------|-----|-------------|-------------|
| **ドメイン知識** | 「中央競馬は土日開催」「オッズは発走直前まで変動」 | 人間 | 低い（業務ルールはコード変更で変わらない） |
| **技術的事実** | 「purchase-ipat はポーリング常駐」「ipat.dev は購入をスキップ」 | コード | 高い（コード変更で即座に陳腐化する） |

**技術的事実を docs に書くと必ず陳腐化する。** これは特定のプロジェクトの問題ではなく、構造的に不可避である。

一方、ドメイン知識は陳腐化リスクが低く、かつコードからは導出できない。これこそ docs に書くべき情報である。

この分析により「System Overview Docs はドメイン知識を伝達する。技術的事実はコードから都度導出する」という原則を導出した。

### 3.4 第四段階: 3層モデルへの拡張

さらに retrain インシデントの分析を加え、2種類の情報分類では不十分であることが判明した。

retrain インシデントは技術的事実の誤認ではない。AI はコードの挙動を正しく理解できたはずだが、**その運用上の帰結を想像しなかった**。これは「外部サービスへの無制限アクセスは避けるべき」というプロジェクト固有の行動原則が AI に伝達されていなかったことが原因である。

この行動原則はドメイン知識（なぜそうなのか）とも技術的事実（何が起きるか）とも異なる、**AI の行動を直接制約するルール**である。

## 4. 結論: 3層情報アーキテクチャ

AI エージェントがプロジェクトで有効に働くために必要な情報は3層に分類される。

| 層 | 内容 | 自然な置き場所 | 特性 |
|---|---|---|---|
| **行動原則** | プロジェクト固有の制約・禁止事項・注意点 | `.claude/rules/`（プロジェクト固有ルールファイル） | AI が理由を理解しなくても従うべきルール。「何をすべきか / してはいけないか」 |
| **ドメイン文脈** | 業務ルール、運用要件、ドメインの常識 | System Overview Docs | AI が応用・判断するための背景材料。「なぜそうなのか」 |
| **技術的事実** | コードの挙動、データフロー、実装詳細 | コード（都度調査） | コードが唯一の真実。「実際に何が起きるか」 |

**現行システムは、この3層を System Overview Docs に全部詰め込んでいる。** その結果:

- **技術的事実が陳腐化する** → RFC 5-1 の #1, #2（docs の記載と実装が乖離）
- **ドメイン文脈が欠落する** → RFC 5-1 の #3〜#6（業務知識が docs に書かれていない）
- **行動原則がどこにもない** → retrain インシデント（運用上の制約が AI に伝達されていない）

### 4.1 各層の具体例（abel の場合）

#### Layer 1: 行動原則 (`.claude/rules/`)

abel 固有の行動原則はプロジェクトローカルのルールファイル（例: `.claude/rules/abel-operations.md`）に配置する。

```markdown
## 外部サービスとの連携
- abel は netkeiba.com（スクレイピング）と IPAT（馬券購入）に接続する実システムである
- 外部サービスへのアクセスを伴う処理は、必ず範囲制限（期間・件数・対象）を明示すること
- 引数省略時に無制限動作となるデフォルト値を設計に含めないこと
- IPAT 購入系の操作は不可逆。テスト・開発時は ipat.dev: true を前提とすること

## 運用上の制約
- 本システムは cron による完全自動運用を前提とする。人間の介在を要する設計は不可
- 中央競馬（JRA）の土日開催のみが対象
```

#### Layer 2: ドメイン文脈 (System Overview Docs)

docs に書くべきもの（ドメイン知識）:
- オッズの変動特性、発走直前の取得が必要な理由
- レースデーのタイムライン（出馬表取得 → 予測 → 購入 → 結果確認）
- 再学習の考え方（どの期間のデータが必要か、トリガー条件）
- IPAT 連携の業務フロー（なぜ全フローを実行して最後だけスキップするのか）

docs から除くべきもの（技術的事実）:
- 「`purchase-ipat` は watchSpanTime 分ごとにポーリングする」
- 「`ipat.dev: true` で購入をスキップする」
- 「`race-time-watcher.js` が発走時間を監視する」

#### Layer 3: 技術的事実 (コード)

RFC Author がコードベースを直接調査して都度把握する。System Overview Docs はオリエンテーション（どこを見ればいいか）を提供するが、コードの挙動そのものは記載しない。

### 4.2 docs に残すもの・除くものの判断基準

| 判断基準 | docs に書く | docs に書かない |
|---------|-----------|---------------|
| コードから導出できるか？ | できない（ドメイン知識） | できる（技術的事実） |
| コード変更で陳腐化するか？ | しない（業務ルール） | する（実装詳細） |
| AI の行動を制約するルールか？ | → `.claude/rules/` に書く | - |

具体的な線引き:

```
✅ docs に書く: 「中央競馬（JRA）のみ対象。土日開催のみ。」        → ドメイン知識
✅ docs に書く: 「purchases/ は IPAT 連携を担う」                   → 構造的オリエンテーション
✅ docs に書く: 「ML パイプラインは Python (LightGBM)」             → 技術選定（安定的）
❌ docs から除く: 「purchase-ipat は watchSpanTime 分ごとにポーリング」→ 技術的事実
❌ docs から除く: 「ipat.dev: true で購入をスキップ」                  → 技術的事実
```

### 4.3 本モデルが解消する矛盾

RFC 品質分析の議論で浮上した以下の矛盾に対する回答:

> System Overview Docs をどこまで信頼するか？

→ ドメイン知識は信頼してよい（陳腐化リスクが低い）。技術的事実は docs に書かないのでこの問題自体が消える。

> 仮に正しいとしても、Docs だけでどこまで正しくコードが把握できるか？

→ Docs の役割はコード把握ではなくドメイン知識の伝達。コード把握は RFC Author がコードを直接読んで行う。

> レビュアーがコードを詳細に見るとコストがかかり過ぎる

→ Author がコードから直接理解を構築するため、docs 起因の事実誤認が構造的に排除される。レビュアーがコードを見る必要性が下がる。

### 4.4 本モデルの限界と考察

#### ドメイン知識の欠如

RFC 5-1 の #3〜#6 は、docs にドメイン知識が書かれていなかったことが原因である。情報アーキテクチャの変更（何をどこに書くかの整理）だけでは内容の充実は担保できない。docs のドメイン知識を充実させる作業は別途必要である。

ただし、System Overview Docs の役割を「ドメイン知識に集中」と再定義することで、**何を docs に書くべきかの判断基準が明確になる**。技術的事実の記述義務がなくなった分、ドメイン知識の記述に集中できる。

#### 人間のコード把握

docs から技術的事実を除くと、人間が docs を通読してシステム概要を把握するユースケースの有用性は低下する。

ただし、AI コーディング時代においては「docs を通読して概要を把握する」から「知りたい情報を都度 AI に聞く」にワークフローが移行しつつある可能性がある。docs の価値は「網羅的な技術解説」から「AI がコードを読む前のオリエンテーション + AI が導出できないドメイン知識」にシフトする。

#### エンタープライズ規模での適用

コード調査のコストは RFC のスコープに比例し、コードベース全体には比例しない。構造的オリエンテーション（architecture.md）が「どこを見ればいいか」を提供するため、規模への依存は限定的と考える。

むしろ、エンタープライズ規模で「技術的事実を docs に書いて同期を維持する」方が破綻するリスクが高い。コード変更のたびに docs を更新する義務は、規模が大きくなるほど非現実的になる。

実証は今後の課題である。

## 5. 改善アクション（案）

| # | スコープ | アクション | 対象 |
|---|---------|----------|------|
| 1 | vdev | CLAUDE.md の System Overview Docs 定義を3層モデルに沿って改定 | `adapters/claude/CLAUDE.md` |
| 2 | vdev | `/rfc` Step 5 の調査指示を「ドメイン知識は docs から、技術的事実はコードから」に修正 | `adapters/claude/commands/rfc.md` |
| 3 | abel | `.claude/rules/` にプロジェクト固有の行動原則ファイルを追加 | `.claude/rules/abel-operations.md`（仮称） |
| 4 | abel | ops.md をドメイン知識中心に再編（技術的事実の記述を除去） | `docs/ops.md` |

### csync との共存方針

CLAUDE.md は vdev の共通定義のまま変更しない。プロジェクト固有の行動原則は `.claude/rules/` 配下にプロジェクトローカルのファイルとして配置し、各プロジェクトリポジトリで管理する。

- **csync が管理するファイル（vdev → 各リポジトリ）**: `CLAUDE.md`, `.claude/rules/doc-comments.md`, `.claude/rules/testing-policy.md`, `.claude/commands/` 等
- **プロジェクトが管理するファイル（各リポジトリローカル）**: `.claude/rules/abel-operations.md` 等のプロジェクト固有ルール

現行の csync は rsync で `--delete` オプションなしのため、プロジェクト固有のファイルは同期時に削除されない。ただし、将来の csync 変更で破壊されないよう、以下の命名規約を設ける:

- **vdev 共通ルール**: 機能名ベース（`doc-comments.md`, `testing-policy.md`）
- **プロジェクト固有ルール**: プロジェクト名プレフィックス付き（`abel-operations.md`）

## 6. 未決事項

- 改善アクション #1〜#4 の優先順位と着手順序
- 3層モデルの他プロジェクトへの展開可能性の検証
