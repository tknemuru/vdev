# [RFC] コマンド完了報告へのPR URL記載追加

| 項目 | 内容 |
| :--- | :--- |
| **作成者 (Author)** | AI (Claude) |
| **ステータス** | Draft (起草中) |
| **作成日** | 2026-02-06 |
| **タグ** | commands, developer-experience |
| **関連リンク** | なし |

## 1. 要約 (Summary)

- 開発ワークフローの6コマンド（`/rrfc`, `/rimp`, `/imp`, `/arfc`, `/aimp`, `/upr`）の完了報告に PR URL を記載する改善を行う。
- 現状、完了報告に PR URL が含まれないケースがあり、人間が対象 PR を探す手間が発生している。
- 各コマンド定義ファイル（`.md`）の完了報告セクションに PR URL 記載の指示を追加する。
- `/arfc`・`/aimp` はオーケストレータの完了報告時に `gh pr view` で URL を取得する方式とし、Task 間の結果受け渡し変更を不要とする。

## 2. 背景・動機 (Motivation)

- 開発ワークフローの各コマンドは、最終的に人間に PR レビュー・マージを依頼する完了報告を行う。しかし、現状の完了報告には PR URL が記載されない場合がある。
- URL が記載されないと、人間は GitHub 上で該当 PR を手動検索する必要があり、ワークフローの効率が低下する。
- 特に `/arfc` や `/aimp` のような自動化コマンドでは、複数の Task を経由するため PR URL がオーケストレータまで伝達されず、完了報告から欠落しやすい。
- PR URL は `gh pr view` コマンドで容易に取得可能であり、各コマンド定義に取得・記載指示を追加するだけで解決できる。

## 3. 目的とスコープ (Goals & Non-Goals)

### 目的 (Goals)

- 6コマンド（`/rrfc`, `/rimp`, `/imp`, `/arfc`, `/aimp`, `/upr`）の完了報告に必ず PR URL が含まれるようにする。
- 人間が完了報告から直接 PR にアクセスできるようにし、ワークフローの効率を向上させる。

### やらないこと (Non-Goals)

- コマンドの処理ロジックや Task 間の結果受け渡し構造の変更は行わない。
- 完了報告のフォーマット全体の見直しは行わない（PR URL 追加のみ）。
- `/rfc`, `/urfc`, `/uimp` など、人間への最終承認依頼を含まないコマンドは対象外とする。

## 4. 前提条件・依存関係 (Prerequisites & Dependencies)

- `gh` CLI がインストールされ、認証済みであること（既存コマンドが前提としている条件と同一）。
- 対象コマンドの完了報告時点で PR が作成済みであること（既存フローで保証されている）。

## 5. 詳細設計 (Detailed Design)

### 5.1 変更対象ファイル一覧

対象ファイルはすべて `adapters/claude/commands/` 配下の `.md` ファイルである。

| ファイル | コマンド | 変更箇所 |
|---|---|---|
| `rrfc.md` | `/rrfc` | Step 9 Approve 時の報告文 |
| `rimp.md` | `/rimp` | Step 9 Approve 時の報告文 |
| `imp.md` | `/imp` | Step 7-5 の報告指示 |
| `arfc.md` | `/arfc` | Phase 3 完了報告 |
| `aimp.md` | `/aimp` | Phase 3 完了報告 |
| `upr.md` | `/upr` | Step 10-4 の報告指示 |

### 5.2 各コマンドの変更詳細

#### 5.2.1 `/rrfc`（RFCレビューコマンド）- `rrfc.md`

**変更箇所**: Step 9 の Approve 時報告文（現在の182行目付近）

現状:
```
5. 「レビューが Approve されました。RFC を Accepted に更新し、PR を Ready にしました。人間による最終確認・マージをお願いします。」とユーザに報告する。
```

変更後:
```
5. `gh pr view --json url --jq '.url'` で PR URL を取得する。
6. 「レビューが Approve されました。RFC を Accepted に更新し、PR を Ready にしました。人間による最終確認・マージをお願いします。\n\nPR: {PR URL}」とユーザに報告する。
```

Request Changes 時の報告には PR URL を追加しない。人間へのアクション依頼がないためである。

#### 5.2.2 `/rimp`（実装レビューコマンド）- `rimp.md`

**変更箇所**: Step 9 の Approve 時報告文（現在の191行目付近）

現状:
```
2. 「レビューが Approve されました。PR を Ready にしました。人間による最終確認をお願いします。」とユーザに報告する。
```

変更後:
```
2. `gh pr view --json url --jq '.url'` で PR URL を取得する。
3. 「レビューが Approve されました。PR を Ready にしました。人間による最終確認をお願いします。\n\nPR: {PR URL}」とユーザに報告する。
```

Request Changes 時の報告には PR URL を追加しない。

#### 5.2.3 `/imp`（実装開始コマンド）- `imp.md`

**変更箇所**: Step 7-5 の報告指示（現在の81行目付近）

現状:
```
5. 実装した内容の要約をユーザに報告せよ。
```

変更後:
```
5. 実装した内容の要約と PR URL をユーザに報告せよ。
```

`/imp` は Step 7-4 で `gh pr create` を実行しており、その出力に PR URL が含まれる。または `gh pr view --json url --jq '.url'` で取得可能である。

#### 5.2.4 `/arfc`（自動RFCコマンド）- `arfc.md`

**変更箇所**: Phase 3 完了報告（現在の71行目付近）

現状:
```
RFC レビューループが完了しました。

- **Status**: Accepted
- **RFC**: docs/rfcs/{slug}/rfc.md
- **Branch**: rfc/{slug}
- **レビューラウンド数**: {iteration}

PR を Ready にしました。人間による最終確認・マージをお願いします。
```

変更後:

Phase 3 の手順に `gh pr view rfc/{slug} --json url --jq '.url'` で PR URL を取得するステップを追加し、報告テンプレートに `- **PR**: {PR URL}` を追加する。

```
Phase 3 完了報告の前に、以下のコマンドで PR URL を取得せよ:
gh pr view rfc/{slug} --json url --jq '.url'
```

```
RFC レビューループが完了しました。

- **Status**: Accepted
- **RFC**: docs/rfcs/{slug}/rfc.md
- **Branch**: rfc/{slug}
- **PR**: {PR URL}
- **レビューラウンド数**: {iteration}

PR を Ready にしました。人間による最終確認・マージをお願いします。
```

この方式では、Task の結果受け渡しを変更せず、オーケストレータが完了報告時に直接 `gh pr view` で URL を取得する。

#### 5.2.5 `/aimp`（自動実装コマンド）- `aimp.md`

**変更箇所**: Phase 3 完了報告（現在の68行目付近）

現状:
```
実装レビューループが完了しました。

- **Status**: Approved
- **Branch**: feature/{slug}
- **レビューラウンド数**: {iteration}

PR を Ready にしました。人間による最終確認・マージをお願いします。
```

変更後:

Phase 3 の手順に `gh pr view feature/{slug} --json url --jq '.url'` で PR URL を取得するステップを追加し、報告テンプレートに `- **PR**: {PR URL}` を追加する。

```
Phase 3 完了報告の前に、以下のコマンドで PR URL を取得せよ:
gh pr view feature/{slug} --json url --jq '.url'
```

```
実装レビューループが完了しました。

- **Status**: Approved
- **Branch**: feature/{slug}
- **PR**: {PR URL}
- **レビューラウンド数**: {iteration}

PR を Ready にしました。人間による最終確認・マージをお願いします。
```

#### 5.2.6 `/upr`（PRコメント対応コマンド）- `upr.md`

**変更箇所**: Step 10-4 の報告指示（現在の179行目付近）

現状:
```
4. 修正内容の要約をユーザに報告せよ。
```

変更後:
```
4. 修正内容の要約と PR URL をユーザに報告せよ。
```

`/upr` は Step 3 で `gh pr view` を既に実行しており PR 番号を保持している。`gh pr view --json url --jq '.url'` で URL を取得可能である。

### 5.3 PR URL の取得方法

すべてのコマンドで `gh pr view` を使用する。ブランチの指定方法はコマンドにより異なる。

| パターン | コマンド | 取得方法 |
|---|---|---|
| カレントブランチから取得 | `/rrfc`, `/rimp`, `/imp`, `/upr` | `gh pr view --json url --jq '.url'` |
| ブランチ名を指定して取得 | `/arfc`, `/aimp` | `gh pr view {branch} --json url --jq '.url'` |

## 6. 代替案の検討 (Alternatives Considered)

### 案A: オーケストレータ完了報告時に `gh pr view` で取得（採用案）

- **概要**: `/arfc`・`/aimp` はオーケストレータが完了報告の直前に `gh pr view` で PR URL を取得する。`/rrfc`・`/rimp`・`/imp`・`/upr` は各コマンド内で `gh pr view` を実行する。
- **長所**: Task 間の結果受け渡し構造を変更する必要がない。各コマンドの変更が独立しており、影響範囲が小さい。
- **短所**: `/arfc`・`/aimp` では完了報告時に追加の `gh` コマンド実行が必要となる（ただし軽量なコマンドであり実質的な影響はない）。

### 案B: Task の結果に PR URL を含めて受け渡す

- **概要**: 各 Task の出力フォーマットに PR URL フィールドを追加し、オーケストレータが Task の結果から PR URL を抽出する。
- **長所**: 完了報告時の追加コマンド実行が不要である。
- **短所**: Task の出力フォーマット仕様の変更が必要となり、影響範囲が広がる。オーケストレータ側で結果のパース処理を追加する必要がある。Task が PR URL を取得するタイミングと出力フォーマットの整合性を保つ必要がある。

### 選定理由

- 案A を採用する。PR URL の取得は `gh pr view` の1回の実行で完結し、既存の Task 間インターフェースを一切変更しない。変更箇所がコマンド定義ファイル内の報告文言のみに限定されるため、シンプルかつ安全である。

## 7. 横断的関心事 (Cross-Cutting Concerns)

### 7.1 セキュリティとプライバシー

- PR URL は GitHub 上の公開情報（またはリポジトリのアクセス権限に従った情報）であり、セキュリティ上の新たなリスクはない。

### 7.2 スケーラビリティとパフォーマンス

- `gh pr view` は軽量なコマンドであり、パフォーマンスへの影響は無視できる。

### 7.3 可観測性 (Observability)

- 該当なし。コマンド定義ファイル（`.md`）の修正のみであり、ログやメトリクスへの影響はない。

### 7.4 マイグレーションと後方互換性

- コマンド定義ファイルの修正であり、破壊的変更はない。完了報告に情報が追加されるのみであるため、既存ワークフローとの互換性は完全に維持される。

## 8. テスト戦略 (Test Strategy)

- 対象がコマンド定義ファイル（Markdown）のみであるため、自動テストの対象外である。
- 検証方法: 各コマンドを実行し、完了報告に PR URL が含まれることを目視確認する。
- 検証観点:
  - `/rrfc`・`/rimp`: Approve 時に PR URL が報告に含まれること。Request Changes 時には含まれないこと。
  - `/imp`: 完了報告に PR URL が含まれること。
  - `/arfc`・`/aimp`: 完了報告に PR URL が含まれること。`gh pr view` の実行が正常に動作すること。
  - `/upr`: 完了報告に PR URL が含まれること。

## 9. 実装・リリース計画 (Implementation Plan)

- **フェーズ1（一括実装）**: 6ファイルの修正を1コミットで実施する。変更が軽微かつ相互に独立しているため、フェーズ分割は不要である。
- **成果物**: 修正済みの6つのコマンド定義ファイル。
- **検証**: 各コマンドの実行時に PR URL が完了報告に含まれることを確認する。
- **システム概要ドキュメントへの影響**: `docs/architecture.md`, `docs/domain-model.md`, `docs/api-overview.md` はいずれも存在しないため、影響はない。
