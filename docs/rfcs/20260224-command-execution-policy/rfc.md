# [RFC] コマンド実行ポリシールールの新設

| 項目 | 内容 |
| :--- | :--- |
| **作成者 (Author)** | Claude (RFC Author) |
| **ステータス** | Accepted (承認済) |
| **作成日** | 2026-02-24 |
| **タグ** | rules, commands, execution-policy |
| **関連リンク** | なし |

<!-- 記述形式ルール（全セクション共通）:
1. 80文字上限: 1箇条書き項目・1テーブルセルは80文字以内
   80文字に収まらない場合はサブ項目分割またはテーブル行分割
2. 散文禁止（例外あり）:
   §1のみ散文許可（5文以内）
   §11のコードブロック間補足は2文以内の散文許可
   他セクションは散文禁止でテーブルまたは箇条書きのみ
3. §1-5 コード識別子禁止:
   バッククォートで囲まれたコード識別子の使用を禁止
   （ファイル名、関数名、変数名、パス、コマンド）
   機能名称またはドメイン用語で記述すること
-->

## 1. 背景・動機 (Motivation)

<!-- 散文で記述。ただし5文以内。 -->

Claude Code のビルトインシステムプロンプトには「コミット・プッシュはユーザの明示的な指示なしに行うな」という強い制約が含まれている。一方、vdev のカスタムコマンド群はコミット・プッシュ・PR作成を明示的なステップとして定義しており、ユーザがコマンドを実行した時点でこれらの操作を含むワークフロー全体の実行を意図している。バージョン更新に伴い、モデルがビルトイン制約をカスタムコマンド定義より重く解釈し、コマンド内のコミット・プッシュ・PR作成ステップが実行されなくなる問題が発生した。ルール定義ファイルを新設し、コマンド定義内のステップはユーザによる明示的な実行指示とみなすポリシーを定義することで、この優先順位の衝突を解消する。

## 2. 機能要件

### 達成すべき要件

<!-- コード識別子禁止。機能名称またはドメイン用語で記述。 -->

| ID | 要件 |
|----|------|
| F1 | コマンド実行ポリシールールを新設する |
| F2 | スラッシュコマンド実行時、コマンド定義内の全ステップをユーザの明示的指示とみなす旨を定義する |
| F3 | コマンド定義内のステップについて個別のユーザ確認を不要とする旨を定義する |
| F4 | Task経由の内部呼び出しにも同一ポリシーを適用する旨を定義する |
| F5 | 適用範囲をコマンド定義ディレクトリ配下の全コマンドと定義する |

### やらないこと

- ビルトインシステムプロンプト自体の変更や上書き
- コマンド定義ファイル群の修正（ルール定義のみで解決する）
- コマンド外の自由会話におけるコミット・プッシュ制約の緩和

## 3. 非機能要件

### 達成すべき要件

| ID | 分類 | 要件 |
|----|------|------|
| N1 | 安全性 | コマンド外の自由会話では従来通りビルトイン制約が適用されること |
| N2 | 一貫性 | 直接実行とTask経由の内部呼び出しで同じポリシーが適用されること |
| N3 | 保守性 | コマンド定義の追加・変更時にポリシールールの修正が不要であること |

### やらないこと

- コマンド実行時のユーザ確認ダイアログの追加

## 4. 実現方式

<!-- 機能要件・非機能要件をどう実現するかの高レベル方針。 -->

| 要件 | 実現方式 |
|------|----------|
| F1-F5 コマンド実行ポリシーの定義 | ルール定義ディレクトリにポリシーファイルを新設し、コマンド実行時の権限委譲ルールを記述する |
| N1 安全性の確保 | 適用範囲をコマンド定義内のステップに限定し、コマンド外には適用しない旨を明記する |
| N3 保守性の確保 | コマンド定義ディレクトリを適用範囲として参照し、個別コマンド名を列挙しない |

## 5. 代替案の検討

<!-- §4の実現方式に対する代替案。最低2案を比較。 -->

| 案 | 概要 | 採否 | 決定的理由 |
|----|------|------|------------|
| A: ルールファイル新設 | ルール定義にコマンド実行ポリシーを追加し、ビルトイン制約との優先順位を明示する | **採用** | コマンド定義の修正が不要で、全コマンドに一括適用でき、保守性が高い |
| B: 各コマンド定義に注記を追加 | 各コマンド定義ファイルに「このステップはユーザの明示的指示である」という注記を個別に追加する | 却下 | 14個の全コマンド定義を修正する必要があり、新規コマンド追加時に注記漏れが発生する |
| C: CLAUDE.mdに記述 | プロジェクト指示のCLAUDE.mdにコマンド実行ポリシーを記述する | 却下 | ルール定義と指示文書の責務分離に反し、csyncで他リポジトリに配布するルールとしての一貫性が損なわれる |

## 6. 外部仕様 (External Specification)

<!-- ユーザ・運用者視点の振る舞い。箇条書き＋コード例。 -->

- ユーザがスラッシュコマンドを実行すると、コマンド定義内の全ステップが個別確認なしに順次実行される
- コミット・プッシュ・PR作成を含むステップも中断なく自動実行される
- Task経由で内部呼び出しされるコマンドも同様に全ステップが自動実行される
- コマンド外の自由会話では従来通りコミット・プッシュの明示的な指示が必要

### 動作例

```
# スラッシュコマンド実行時（ポリシー適用）
ユーザ: /fix
→ RFC作成 → コミット → プッシュ → PR作成 → マージ → 実装
  → コミット → プッシュ → PR作成（全ステップ自動実行）

# 自由会話時（ビルトイン制約適用）
ユーザ: このバグを直して
→ コード修正まで実行。コミット・プッシュはユーザの明示的指示を待つ
```

## 7. 結合テスト仕様

<!-- /vfyで実施するテスト。要件寄りで記述。 -->

| ID | 対応要件 | テスト内容 | 期待結果 |
|----|----------|------------|----------|
| T1 | F1 | コマンド実行ポリシールールファイルが存在するか確認する | ルール定義ディレクトリにファイルが存在する |
| T2 | F2 | ルールファイルにコマンド定義内ステップをユーザの明示的指示とみなす記述があるか確認する | 該当記述が存在する |
| T3 | F3 | ルールファイルに個別確認不要の記述があるか確認する | 該当記述が存在する |
| T4 | F4 | ルールファイルにTask経由の内部呼び出しへの適用記述があるか確認する | 該当記述が存在する |
| T5 | F5 | ルールファイルの適用範囲がコマンド定義ディレクトリ配下の全コマンドを対象としているか確認する | 該当記述が存在する |
| T6 | N1 | ルールファイルにコマンド外への非適用が明記されているか確認する | コマンド外では従来の制約が適用される旨の記述がある |

## 8. ドキュメント編集仕様

<!-- システム概要ドキュメント等の作成・更新・削除。 -->

| 対象ファイル | 操作 | 変更内容 |
|-------------|------|----------|
| コマンド実行ポリシールール | 作成 | コマンド実行時の権限委譲ポリシーを定義 |

システム概要ドキュメントは本リポジトリに存在しないため、更新対象はない。

## 9. Task計画

<!-- Phase/フェーズによる作業分割を禁止する。 -->
<!-- 全作業項目は単一のPRで完遂すること。 -->

| # | 種別 | 作業内容 | 依存 |
|---|------|----------|------|
| 1 | コード | コマンド実行ポリシールールファイルの新設 | - |
| 2 | 適用 | ルールファイルのデプロイ先ディレクトリへのコピー | #1 |
| 3 | テスト | 結合テスト仕様に基づく全テスト実行 | #2 |

### ロールバック基準と手順

- **基準**: ルール追加後にコマンド外の自由会話でコミット・プッシュが無断実行される場合
- **手順**: Markdownファイル1つの追加のみであるため、`git revert` で完了する

## 10. 前提条件・依存関係

| 種別 | 内容 |
|------|------|
| ファイル依存 | 変更対象は全てMarkdownファイルであり、外部ツール・ライブラリへの依存はない |
| 前提 | ルール定義ディレクトリ配下のMarkdownファイルがClaude Codeのシステムプロンプトとして自動読み込みされること |
| 前提 | ルール定義はビルトインシステムプロンプトと同じレイヤーで解釈され、矛盾時はルール定義が優先されること |

## 11. 詳細設計 (Detailed Design)

<!-- 箇条書き＋コード例。 -->
<!-- コードブロック間補足は2文以内の散文許可。 -->

### 11.1 コマンド実行ポリシールールファイル

`adapters/claude/rules/command-execution-policy.md` を以下の内容で新設する。

```markdown
# コマンド実行ポリシー

## 適用範囲

adapters/claude/commands/ 配下に定義されたすべてのコマンドに適用する。

## 原則

ユーザがスラッシュコマンドを実行した場合、そのコマンド定義に含まれる
すべてのステップ（git commit, git push, gh pr create 等を含む）は
ユーザによる明示的な実行指示とみなす。

## ルール

- コマンド定義内のステップについては、個別のユーザ確認を求めずに順次実行する
- Task 経由で内部呼び出しされるコマンドも同様に扱う
  - 例: /fix が /rfc と /imp を Task 経由で呼び出す場合、
    内部の /rfc・/imp の全ステップも明示的指示とみなす

## コマンド外の動作

本ポリシーはコマンド実行時にのみ適用される。
コマンド外の自由会話では、ビルトインの制約
（コミット・プッシュにはユーザの明示的指示が必要）が引き続き適用される。
```

### 11.2 デプロイ先へのコピー

`csync` コマンドが `adapters/claude/` 配下を `.claude/` にコピーする機構により、他リポジトリへは自動配布される。vdev リポジトリ自身では `.claude/rules/command-execution-policy.md` にも同一内容をコピーする。

### 単体テスト仕様

| テスト対象 | 検証観点 |
|-----------|----------|
| コマンド実行ポリシールール | 適用範囲にコマンド定義ディレクトリが指定されていること |
| コマンド実行ポリシールール | 「明示的な実行指示とみなす」旨の記述が含まれること |
| コマンド実行ポリシールール | 「個別のユーザ確認を求めずに順次実行する」旨の記述が含まれること |
| コマンド実行ポリシールール | Task経由の内部呼び出しへの言及が含まれること |
| コマンド実行ポリシールール | コマンド外ではビルトイン制約が適用される旨の記述が含まれること |
