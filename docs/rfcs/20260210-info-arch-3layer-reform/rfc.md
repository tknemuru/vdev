# [RFC] 3層情報アーキテクチャに基づく System Overview Docs 定義と `/rfc` 調査指示の改定

| 項目 | 内容 |
| :--- | :--- |
| **作成者 (Author)** | AI (Claude) |
| **ステータス** | Draft (起草中) |
| **作成日** | 2026-02-10 |
| **タグ** | workflow, information-architecture |
| **関連リンク** | `docs/reports/20260210-report-vdev-flow-information-architecture.md` |

## 1. 要約 (Summary)

- AI エージェントがプロジェクトで有効に働くために必要な情報を「行動原則」「ドメイン文脈」「技術的事実」の3層に分類する情報アーキテクチャモデルに基づき、vdev の2つの定義ファイルを改定する。
- 第一に、`adapters/claude/CLAUDE.md` の System Overview Documents セクションを、ドメイン知識中心の記載ガイドラインに改定し、技術的事実はコードから都度導出する方針を明記する。
- 第二に、`adapters/claude/commands/rfc.md` の Step 5（コードベース調査）を、「ドメイン知識は docs から、技術的事実はコードから」という調査方針に変更する。
- これにより、docs の陳腐化リスクを構造的に低減し、AI がドメイン知識とコードの事実をそれぞれ適切なソースから取得する仕組みを確立する。

## 2. 背景・動機 (Motivation)

- レポート `docs/reports/20260210-report-vdev-flow-information-architecture.md` の分析により、AI エージェントが必要とする情報は3層に分類されることが判明した。

| 層 | 内容 | 自然な置き場所 | 特性 |
|---|---|---|---|
| **行動原則** | プロジェクト固有の制約・禁止事項 | `.claude/rules/` | AI が理由を理解しなくても従うべきルール |
| **ドメイン文脈** | 業務ルール、運用要件、ドメインの常識 | System Overview Docs | AI が応用・判断するための背景材料 |
| **技術的事実** | コードの挙動、データフロー、実装詳細 | コード（都度調査） | コードが唯一の真実 |

- 現行の System Overview Docs 定義は、この3層を区別せず全情報を docs に記載する方針である。その結果、以下の問題が構造的に発生する。
  - **技術的事実の陳腐化**: コード変更のたびに docs との乖離が発生する。RFC 5-1（abel）では docs の記載と実装が乖離し、AI が誤った前提で設計を行った。
  - **ドメイン文脈の欠落**: docs に「何を書くべきか」の基準がないため、技術的事実の記述に偏り、本来必要なドメイン知識が抜け落ちる。
  - **行動原則の不在**: AI の行動を制約するルールの置き場所が定義されておらず、retrain インシデント（abel）のような運用上の事故が発生した。
- 現行の `/rfc` Step 5 は「System Overview Docs を読み込み、その上でコードベースを調査する」という指示であるが、docs から得る情報と コードから得る情報の役割分担が不明確である。AI は docs の記載を事実として受け取り、コードとの照合を十分に行わないリスクがある。
- 放置した場合、csync により全リポジトリに同期される CLAUDE.md と `/rfc` コマンドの定義が改善されないまま、同種の問題が他プロジェクトでも再発する。

## 3. 目的とスコープ (Goals & Non-Goals)

### 目的 (Goals)

| # | Goal | 達成確認方法 (Verification) |
|---|------|-----------------------------|
| G1 | `adapters/claude/CLAUDE.md` の System Overview Documents セクションを3層情報アーキテクチャに沿って改定し、各ドキュメントの記載内容ガイドラインを「ドメイン知識中心」に修正する | 改定後の CLAUDE.md を用いて、AI に未知のプロジェクトの System Overview Docs を起草させ、(1) 技術的事実（エンドポイント一覧、ディレクトリツリー、具体的なデータスキーマ等）がドキュメントに含まれないこと、(2) ドメイン知識（業務ルール、設計意図、運用要件）が中心に記載されていることを確認する |
| G2 | `adapters/claude/commands/rfc.md` の Step 5 を「ドメイン知識は docs から、技術的事実はコードから」の調査方針に変更する | 改定後の `/rfc` を実行し、(1) Step 5a で AI が System Overview Docs からドメイン知識を取得していること、(2) Step 5b で AI がコードを直接調査して技術的事実を把握していること、(3) docs の記載とコードに矛盾がある場合に AI がコードを正として報告するケースを1件以上確認する |

### やらないこと (Non-Goals)

- 各プロジェクトリポジトリの `.claude/rules/` への行動原則ファイルの追加は行わない。本 RFC はフレームワーク（CLAUDE.md とコマンド定義）の改定のみを対象とし、プロジェクト固有の行動原則は各プロジェクトで個別に対応する。
- 既存プロジェクトの System Overview Docs のドメイン知識中心への書き換えは行わない。本 RFC はガイドラインの改定であり、既存 docs の内容修正は別作業である。
- `/rfc` 以外のコマンド（`/arfc`, `/imp` 等）の変更は行わない。他コマンドが System Overview Docs を参照する箇所への影響は、CLAUDE.md の記載変更により間接的にカバーされる。
- `.claude/rules/` の命名規約や csync の同期ルール変更は行わない。レポートで提案されている命名規約（vdev 共通ルール vs プロジェクト固有ルール）は、本 RFC のスコープ外とする。

## 4. 前提条件・依存関係 (Prerequisites & Dependencies)

- レポート `docs/reports/20260210-report-vdev-flow-information-architecture.md` で提案された3層情報アーキテクチャモデルを前提とする。
- 変更対象は vdev リポジトリ内の2つの Markdown ファイルのみである。外部ツールやライブラリへの依存はない。
- csync（`bin/csync`）による各リポジトリへの同期は既存の仕組みをそのまま使用する。`adapters/claude/CLAUDE.md` は `$REPO_ROOT/CLAUDE.md` に、`adapters/claude/commands/` は `$REPO_ROOT/.claude/commands/` にそれぞれ同期される。

## 5. 詳細設計 (Detailed Design)

### 5.1 変更対象ファイル一覧

| # | ファイル | 変更概要 |
|---|---------|---------|
| 1 | `adapters/claude/CLAUDE.md` | System Overview Documents セクションを3層モデルに沿って改定 |
| 2 | `adapters/claude/commands/rfc.md` | Step 5 の調査指示を「ドメイン知識は docs から、技術的事実はコードから」に変更 |

### 5.2 変更1: CLAUDE.md の System Overview Documents セクション改定

**対象ファイル**: `adapters/claude/CLAUDE.md`

**変更箇所**: `## System Overview Documents（システム概要ドキュメント）` セクション全体を置き換える。

現行:
```markdown
## System Overview Documents（システム概要ドキュメント）

リポジトリごとに以下の3ドキュメントを `docs/` 配下に配置する規約とする。IEEE 1016 Software Design Description の3ビューポイント（Structure / Data / Interface）に対応し、システムの全体像を簡潔に記述する。

| ドキュメント | 目的 | 記載内容 |
|---|---|---|
| `docs/architecture.md` | システム構造の把握 | ディレクトリ構成、レイヤー構造、依存関係、技術選定、デプロイ構成 |
| `docs/domain-model.md` | ドメイン概念・データの把握 | ドメイン概念と関係、業務ルール・制約、状態遷移、データ永続化（DB設計） |
| `docs/api-overview.md` | インターフェース設計の把握 | エンドポイント一覧、認証方式、共通パターン、エラーハンドリング規約 |

既存リポジトリやリポジトリの特性上不要な場合は省略可とする。各コマンドは存在するドキュメントのみ参照する。
```

変更後:
```markdown
## System Overview Documents（システム概要ドキュメント）

AI エージェントがプロジェクトで有効に働くために必要な情報は、行動原則（`.claude/rules/`）・ドメイン文脈（System Overview Docs）・技術的事実（コードから都度調査）の3層に分類される。System Overview Docs はこのうち **ドメイン知識と構造的オリエンテーション** を提供するためのドキュメントであり、コードの挙動や実装詳細は記載しない。

リポジトリごとに以下の3ドキュメントを `docs/` 配下に配置する規約とする。IEEE 1016 Software Design Description の3ビューポイント（Structure / Data / Interface）に対応する3ドキュメント構成を維持し、各ドキュメントの記載内容をドメイン知識中心に定義する。

| ドキュメント | 目的 | 記載内容 |
|---|---|---|
| `docs/architecture.md` | システム構造のオリエンテーション | 主要ディレクトリの責務概要、レイヤー構造、コンポーネントの責務分担、技術選定の理由、デプロイ構成 |
| `docs/domain-model.md` | ドメイン知識の伝達 | ドメイン概念と関係、業務ルール・制約、運用要件、ドメイン固有の前提知識 |
| `docs/api-overview.md` | インターフェースの設計意図 | API の設計方針、認証方式、共通パターン、エラーハンドリング規約 |

既存リポジトリやリポジトリの特性上不要な場合は省略可とする。各コマンドは存在するドキュメントのみ参照する。

### 記載内容の判断基準

| 判断基準 | docs に書く | docs に書かない |
|---------|-----------|---------------|
| コードから導出できるか？ | できない（ドメイン知識） | できる（技術的事実） |
| コード変更で陳腐化するか？ | しない（業務ルール・設計意図） | する（実装詳細） |
| AI の行動を制約するルールか？ | → `.claude/rules/` に書く | — |

技術的事実（コードの挙動、データフロー、処理の詳細）はコードが唯一の真実であり、docs に記載すると陳腐化が不可避である。AI はコードを直接調査して技術的事実を把握すること。コードに明示されない意思決定の背景・理由は docs に書く。
```

変更のポイント:
- 3層モデルの定義テーブルは冒頭の1文の要約に集約し、CLAUDE.md の記載量を最小限にとどめる。AI が実際に従うべきルールである「記載内容の判断基準」テーブルと System Overview Documents テーブルに情報を集約する。
- IEEE 1016 の3ビューポイント（Structure / Data / Interface）に対応する3ドキュメント構成の設計根拠は維持する。記載内容のガイドラインをドメイン知識中心に改定する点が変更の本質であり、ドキュメント構成自体の根拠は引き続き有効である。
- 各ドキュメントの「記載内容」を、技術的事実を含む記述からドメイン知識・構造的オリエンテーション中心の記述に修正する。具体的には:
  - `architecture.md`: 完全なディレクトリツリーの記載は除去するが、「主要ディレクトリの責務概要」として構造的オリエンテーション目的の記載を残す。AI が大規模リポジトリで調査の起点を得られるようにする。「コンポーネントの責務分担」「技術選定の理由」を追加する。
  - `domain-model.md`: 「データ永続化（DB設計）」（技術的事実）を除去し、「運用要件」「ドメイン固有の前提知識」に変更。
  - `api-overview.md`: 「エンドポイント一覧」（コードから導出可能）を除去し、「API の設計方針」に変更。
- 「記載内容の判断基準」サブセクションを新設し、docs に書くべき情報と書くべきでない情報の基準を明示する。境界ケースの判断指針として「コードに明示されない意思決定の背景・理由は docs に書く」旨を追記する。

### 5.3 変更2: `/rfc` Step 5 の調査指示改定

**対象ファイル**: `adapters/claude/commands/rfc.md`

**変更箇所**: Step 5 全体を置き換える。

現行の Step 5:
```markdown
### Step 5: コードベース調査

カレントリポジトリのルート（`git rev-parse --show-toplevel`）を基準に、以下のシステム概要ドキュメントが存在する場合は**並列に（単一メッセージ内で同時に）**読み込め（存在しないファイルはスキップ）:
- `docs/architecture.md`
- `docs/domain-model.md`
- `docs/api-overview.md`

その上で、元ネタ文章に関連するコードベースを調査し、現行アーキテクチャ・データモデル・依存関係を把握せよ。調査結果は Step 6 の起草時に「背景・動機」「詳細設計」へ反映する。
```

変更後の Step 5:
```markdown
### Step 5: コードベース調査

#### 5a. ドメイン知識の取得

カレントリポジトリのルート（`git rev-parse --show-toplevel`）を基準に、以下のシステム概要ドキュメントが存在する場合は**並列に（単一メッセージ内で同時に）**読み込め（存在しないファイルはスキップ）:
- `docs/architecture.md`
- `docs/domain-model.md`
- `docs/api-overview.md`

これらのドキュメントからは **ドメイン知識**（業務ルール、運用要件、ドメインの常識）と **構造的オリエンテーション**（どのコンポーネントがどの責務を担うか、どこを見ればいいか）を取得する。

#### 5b. 技術的事実の調査

元ネタ文章に関連するコードベースを直接調査し、現行の実装・データフロー・依存関係を把握せよ。技術的事実（コードの挙動、処理の流れ、データ構造）はコードが唯一の真実であり、System Overview Docs の記載ではなくコードから導出すること。

**注意**: System Overview Docs に技術的事実の記載がある場合でも、それを無条件に信頼してはならない。コードと docs の記載に矛盾がある場合は、コードを正とする。

#### 5c. 調査結果の反映

ドメイン知識とコード調査の結果を統合し、Step 6 の起草時に「背景・動機」「詳細設計」へ反映する。
```

変更のポイント:
- Step 5 を 5a（ドメイン知識の取得）、5b（技術的事実の調査）、5c（調査結果の反映）の3段階に分割し、情報のソースと取得目的を明確にする。
- 5a では System Overview Docs の役割を「ドメイン知識」と「構造的オリエンテーション」の提供に限定する。
- 5b では技術的事実の調査先がコードであることを明示する。「コードが唯一の真実」という原則を直接記載する。
- docs の記載を無条件に信頼しない旨の注意書きを追加する。既存の docs に技術的事実が残存している過渡期において、AI が docs の記載とコードの矛盾に気づけるようにする。
- `/rfc` コマンドの Step 5 以外のステップ（Step 6 等）が System Overview Docs を技術的事実のソースとして暗黙に参照していないことを確認済みである。Step 6.5 はシステム概要ドキュメントへの「影響判断」を指示しているが、これは docs の内容を技術的事実として利用するものではなく、更新対象の特定を目的としており、本改定と矛盾しない。

## 6. 代替案の検討 (Alternatives Considered)

### 案A: CLAUDE.md と `/rfc` Step 5 の同時改定（採用案）

- **概要**: CLAUDE.md の情報アーキテクチャ定義と `/rfc` の調査指示を同時に改定する。CLAUDE.md で「何をどこに書くか」の原則を定義し、`/rfc` で「どこから何を取得するか」の実践手順を定義する。
- **長所**: 原則（CLAUDE.md）と実践（`/rfc`）が整合した状態で同時にリリースされる。CLAUDE.md のみ改定した場合、`/rfc` の調査指示が旧来のままで原則と矛盾する過渡期が生じるが、同時改定ならこの矛盾を回避できる。
- **短所**: 変更が2ファイルにまたがる。ただし、いずれも Markdown の文言修正であり、相互に密接に関連する内容であるため、分割する合理性は低い。

### 案B: CLAUDE.md のみ改定し、`/rfc` は変更しない

- **概要**: CLAUDE.md の情報アーキテクチャ定義のみを改定する。`/rfc` の調査指示は現行のままとし、CLAUDE.md の記載内容ガイドラインが間接的に AI の調査行動を変えることを期待する。
- **長所**: 変更範囲が最小限である。
- **短所**: `/rfc` Step 5 は「System Overview Docs を読み込み、その上でコードベースを調査する」という指示のままであり、docs から得る情報とコードから得る情報の役割分担が不明確なまま残る。CLAUDE.md のガイドライン変更だけでは、AI が実際にコードを優先的に調査するかどうかは不確実である。原則と実践の間にギャップが残るため、効果が限定的になるリスクがある。

### 案C: Step 5 を大幅に詳細化し、具体的な調査手順を追加

- **概要**: `/rfc` Step 5 に「変更対象のコードを grep で特定する」「関連するテストを読む」等の具体的な調査手順を追加する。
- **長所**: AI の調査行動をより具体的に制御できる。
- **短所**: レポートの分析（セクション 3.1）で棄却された「ルール追記型」アプローチに該当する。特定の問題への局所解であり、将来の異なる問題に対して追記が必要になる。コマンド定義の肥大化・煩雑化を招く。本 RFC の目的は「情報のソースと役割分担の原則を定義する」ことであり、具体的な調査手順の追加は目的が異なる。

### 選定理由

- 案A を採用する。CLAUDE.md の原則定義と `/rfc` の実践手順は一体の関係にあり、同時に改定しなければ整合性を担保できない。案B は実践の変更を間接効果に頼る点で不確実であり、案C はレポートで既に棄却された方向性である。

## 7. 横断的関心事 (Cross-Cutting Concerns)

### 7.1 セキュリティとプライバシー

- 対象はワークフロー定義ファイル（Markdown）のみであり、セキュリティ上の新たなリスクはない。

### 7.2 スケーラビリティとパフォーマンス

- `/rfc` Step 5 の調査指示が詳細化されることで、RFC 起草時の調査にかかる時間がわずかに増加する可能性がある。ただし、docs の記載を鵜呑みにして誤った前提で設計する（RFC 5-1 の事例）よりも、コードを直接調査して正確な理解を構築するコストのほうが総合的には小さい。

### 7.3 可観測性 (Observability)

- 該当なし。Markdown ファイルの修正のみである。

### 7.4 マイグレーションと後方互換性

- CLAUDE.md の変更は csync により全リポジトリに同期される。同期後、各リポジトリの `CLAUDE.md` が新しいガイドラインに置き換わる。既存の System Overview Docs の内容は自動的には変わらない。新ガイドラインに合わせた docs の改修は各プロジェクトで段階的に行う。
- `/rfc` コマンドの変更も csync により全リポジトリに同期される。次回以降の `/rfc` 実行時から新しい調査方針が適用される。
- 既存の System Overview Docs に技術的事実が含まれている過渡期への対処として、Step 5 に「docs の記載を無条件に信頼しない」旨の注意書きを含めている。
- 既存 docs の新ガイドラインへの改修は、各プロジェクトの次回 RFC 起草時や System Overview Docs の更新契機など、自然なタイミングで段階的に行う。専用の一斉改修作業は不要であり、通常の開発フローの中で漸進的に移行する。
- ロールバックは各ファイルの変更を revert するだけで完了する。

## 8. テスト戦略 (Test Strategy)

- 対象がワークフロー定義ファイル（Markdown）のみであるため、自動テストの対象外である。
- 検証方法: 変更後の各ファイルの内容を Read で読み込み、Goals テーブルの Verification に記載した手順で確認する。
  - `adapters/claude/CLAUDE.md`: 3層モデル定義、ドメイン知識中心の記載ガイドライン、判断基準の存在を引用で確認する。
  - `adapters/claude/commands/rfc.md`: Step 5 の3段階構成（ドメイン知識取得・技術的事実調査・結果統合）と、コードを正とする方針を引用で確認する。

## 9. 実装・リリース計画 (Implementation Plan)

- **フェーズ1（一括実装）**: 2ファイルの修正を1コミットで実施する。変更は相互に関連し、いずれも Markdown の文言修正であるため、フェーズ分割は不要である。
- **成果物**: 修正済みの `adapters/claude/CLAUDE.md` と `adapters/claude/commands/rfc.md`。
- **検証**: 各ファイルの変更内容を Goals テーブルの Verification に従って Read で読み込み、引用で確認する。
- **csync 同期**: 実装マージ後、各プロジェクトリポジトリで `csync` を実行し、新しい定義を反映する。
- **システム概要ドキュメントへの影響**: `docs/architecture.md`, `docs/domain-model.md`, `docs/api-overview.md` は vdev リポジトリには存在しないため、直接の更新対象はない。ただし、CLAUDE.md の改定により各プロジェクトの System Overview Docs の記載方針が変わるため、既存 docs のドメイン知識中心への改修は各プロジェクトで別途実施する必要がある。
