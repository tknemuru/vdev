# [RFC] サービス仕様書作成コマンドの新設

| 項目 | 内容 |
| :--- | :--- |
| **作成者 (Author)** | Claude (AI) |
| **ステータス** | Accepted (承認済) |
| **作成日** | 2026-02-28 |
| **タグ** | command, service-spec, quality, e2e-test |
| **関連リンク** | サービス仕様書テンプレートRFC: 20260228-service-spec-template |

<!-- 記述形式ルール（全セクション共通）:
1. 80文字上限: 1箇条書き項目・1テーブルセルは80文字以内
   80文字に収まらない場合はサブ項目分割またはテーブル行分割
2. 散文禁止（例外あり）:
   §1のみ散文許可（5文以内）
   §11のコードブロック間補足は2文以内の散文許可
   他セクションは散文禁止でテーブルまたは箇条書きのみ
3. §1-5 コード識別子禁止:
   バッククォートで囲まれたコード識別子の使用を禁止
   （ファイル名、関数名、変数名、パス、コマンド）
   機能名称またはドメイン用語で記述すること
-->

## 1. 背景・動機 (Motivation)

<!-- 散文で記述。ただし5文以内。 -->

サービス仕様書テンプレートは既に存在するが、仕様書の作成プロセスは手動であり品質を担保する機構がない。特にE2Eテスト要件の品質が低く、テンプレートのコメントを読んでも各機能に基本ケース1つだけの最低限の出力しか得られない。LLM研究が示す通り、指示だけでは出力品質は担保できず、Few-shot例・構造化生成プロセス・チェックリスト検証の組み合わせが必要である。本RFCでは、E2Eテスト要件を体系的に導出する構造化生成プロセスとチェックリスト検証を内蔵したサービス仕様書作成コマンドを新設する。

## 2. 機能要件

### 達成すべき要件

<!-- コード識別子禁止。機能名称またはドメイン用語で記述。 -->

| ID | 要件 |
|----|------|
| FR-1 | サービス仕様書作成コマンドを新設する |
| FR-2 | プロダクトビジョン取得と不足情報ヒアリングを実行する |
| FR-3 | テンプレートを対象リポジトリの所定ディレクトリにコピーする |
| FR-4 | 基盤セクションを依存順序で起草する |
| FR-5 | E2Eテスト要件を4ステップの構造化導出プロセスで生成する |
| FR-6 | E2Eシナリオ導出の中間成果物を仕様書末尾に付録として残す |
| FR-7 | 開発ロードマップを起草する |
| FR-8 | チェックリスト検証を同一エージェント内で実行する |
| FR-9 | チェックリスト失敗項目を修正し再検証する |
| FR-10 | チェックリスト結果サマリをユーザに報告する |
| FR-11 | 作成した仕様書をコミット・プッシュする |

### やらないこと

- 多人格並列レビュー（コスト効率が悪いため不採用）
- 「人間レビューを推奨」等の逃げ道出力
- 別 Task への分割（全て同一エージェント内で完結）
- 既存コマンドの変更（本コマンドは新規追加のみ）

## 3. 非機能要件

### 達成すべき要件

| ID | 分類 | 要件 |
|----|------|------|
| NF-1 | 品質 | E2Eテスト要件のケース数がユーザー機能数の2倍以上であること |
| NF-2 | 品質 | E2Eテストデータがドメイン固有の実データであること |
| NF-3 | 品質 | 異常系テストが最低1件含まれること |
| NF-4 | 検証可能性 | E2Eテストの期待結果がプログラムから検証可能な形式であること |
| NF-5 | トレーサビリティ | E2Eシナリオの導出根拠が付録として追跡可能であること |

### やらないこと

- 仕様書のバリデーションツールの作成
- テンプレート自体の変更

## 4. 実現方式

<!-- 機能要件・非機能要件をどう実現するかの高レベル方針。 -->

| 要件 | 実現方式 |
|------|----------|
| FR-1 | コマンド定義ファイルを新規作成する |
| FR-2 | コマンド定義の Phase 1 でヒアリング手順を記述する |
| FR-3 | コマンド定義内でテンプレートコピー手順を記述する |
| FR-4 | Phase 2 で依存順序（概要→技術→ドメイン→データ→運用→スコープ外）の起草手順を記述する |
| FR-5, NF-1〜5 | Phase 3 で4ステップの Three-Tier Method を記述する |
| FR-6 | Phase 3 の末尾で中間成果物を付録として追記する手順を記述する |
| FR-7 | Phase 4 で開発ロードマップ起草手順を記述する |
| FR-8, FR-9 | Phase 5 でチェックリスト分解型検証と修正ループを記述する |
| FR-10 | Phase 6 でチェックリスト結果の報告手順を記述する |
| FR-11 | Phase 7 でコミット・プッシュ手順を記述する |

## 5. 代替案の検討

<!-- §4の実現方式に対する代替案。最低2案を比較。 -->

| 案 | 概要 | 採否 | 決定的理由 |
|----|------|------|------------|
| A: 構造化生成+チェックリスト検証 | 4ステップ導出と項目別チェックリストを1コマンドに内蔵 | **採用** | 品質の主エンジンが生成プロセス自体に組み込まれる |
| B: テンプレートコメント強化のみ | テンプレートの指示コメントを詳細化する | 却下 | 指示だけでは出力品質が担保できないことが実証済み |
| C: 多人格並列レビュー | 複数人格で仕様書を並列レビューする | 却下 | コスト効率が悪く、品質の主因は生成プロセスにある |

## 6. 外部仕様 (External Specification)

<!-- ユーザ・運用者視点の振る舞い。箇条書き＋コード例。 -->

- ユーザは `/spec` コマンドでサービス仕様書作成を開始する
- コマンドはプロダクトビジョンの入力を求め、不足情報をヒアリングする
- テンプレートが対象リポジトリにコピーされ、7 Phase で仕様書が生成される
- E2Eテスト要件は以下の4ステップで体系的に導出される:
  - ユーザー機能の列挙
  - 条件軸の列挙
  - 具体的テストデータの導出
  - テストケース生成
- 導出過程は仕様書末尾に付録として残る
- チェックリスト検証が自動実行され、結果サマリがユーザに報告される
- 最終成果物はコミット・プッシュされる
- 本コマンドの出力（仕様書の §4.3）が自動開発コマンドの入力となる

## 7. E2Eテスト仕様

<!-- E2Eテストの操作的定義:
ユーザまたは運用者の操作を起点とし、最終的なアウトカム
（ユーザが得る結果）の確認までを一貫して行うシナリオテスト。

OK例:
- CLI で notify を実行し、LINE アプリに通知が届く
- cron スクリプトを実行し、ログに SUCCESS が記録され通知が届く

NG例:
- LINE API にリクエストを送信しレスポンスコードを確認する
- DB に SELECT してレコードが存在することを確認する
- メッセージ構築関数の出力 JSON を確認する

禁止事項:
モック/スタブ/テストフレームワーク経由の実行/内部動作の検証
-->

| ID | 対応要件 | セットアップ手順 | 実行手順 | 期待するアウトカム |
|----|----------|------------------|----------|-------------------|
| T-1 | FR-1 | vdev リポジトリをチェックアウトする | コマンド定義ファイルの存在を確認する | コマンド定義が所定パスに存在する |
| T-2 | FR-2 | 対話セッションでコマンドを起動する | 引数なしで `/spec` を実行する | プロダクトビジョンの入力を求めるプロンプトが表示される |
| T-3 | FR-3 | テスト用リポジトリを用意する | プロダクト情報を入力して Phase 1 を完了させる | テンプレートが対象リポジトリの docs/ にコピーされる |
| T-4 | FR-5, NF-1 | テスト用リポジトリでコマンドを実行し Phase 3 まで完了させる | 生成された仕様書の §2 を確認する | E2Eテストケース数がユーザー機能数の2倍以上である |
| T-5 | FR-5, NF-2 | テスト用リポジトリでコマンドを実行し Phase 3 まで完了させる | 生成された §2 のテストデータを確認する | ドメイン固有の実データが使用されている |
| T-6 | FR-5, NF-3 | テスト用リポジトリでコマンドを実行し Phase 3 まで完了させる | 生成された §2 のテストケースを確認する | 異常系テストが最低1件含まれている |
| T-7 | FR-6, NF-5 | テスト用リポジトリでコマンドを実行し Phase 3 まで完了させる | 生成された仕様書末尾を確認する | 付録にE2Eシナリオ導出過程の中間成果物が存在する |
| T-8 | FR-8, FR-9 | テスト用リポジトリでコマンドを実行し Phase 5 まで完了させる | チェックリスト検証結果を確認する | 全チェック項目がYESである（FAILがあれば修正後に再検証されている） |
| T-9 | FR-10 | テスト用リポジトリでコマンドを実行し Phase 6 まで完了させる | ユーザへの出力を確認する | チェックリスト結果サマリが表示されている |
| T-10 | FR-11 | テスト用リポジトリでコマンドを実行し全 Phase を完了させる | git log で最新コミットを確認する | 仕様書ファイルがコミット・プッシュされている |
| T-11 | NF-4 | テスト用リポジトリでコマンドを実行し Phase 3 まで完了させる | 生成された §2 の期待結果列を確認する | 全ケースの期待結果がプログラムから検証可能な形式である |

## 8. ドキュメント編集仕様

<!-- システム概要ドキュメント等の作成・更新・削除。 -->

| 対象ファイル | 操作 | 変更内容 |
|-------------|------|----------|
| サービス仕様書作成コマンド定義 | 作成 | 7 Phase 構成のコマンド定義を新規配置 |
| システム概要ドキュメント | 対象外 | 本リポジトリに未配置のため影響なし |

## 9. Task計画

<!-- Phase/フェーズによる作業分割を禁止する。 -->
<!-- 全作業項目は単一のPRで完遂すること。 -->
<!-- §7 のセットアップ手順に記載した環境準備は本セクションに「セットアップ」種別のタスクとして含めること。 -->

| # | 種別 | 作業内容 | 依存 |
|---|------|----------|------|
| 1 | コード | サービス仕様書作成コマンド定義を新規作成する | - |

### ロールバック基準と手順

- コマンド定義に構文エラーがあり実行不能な場合
- `git revert` で本PRのコミットを取り消す

## 10. 前提条件・依存関係

| 種別 | 内容 |
|------|------|
| 前提 | サービス仕様書テンプレートが配置済みであること |
| 前提 | 自動開発コマンドがシェルスクリプト化されていること |
| 依存 | なし（vdevリポジトリ内のコマンド定義ファイルのみ追加） |

## 11. 詳細設計 (Detailed Design)

<!-- 箇条書き＋コード例。 -->
<!-- コードブロック間補足は2文以内の散文許可。 -->

### 設計1: コマンド定義ファイルの配置

`adapters/claude/commands/spec.md` に以下の構造でコマンド定義を新規作成する。

```markdown
# /spec - サービス仕様書作成コマンド

サービス仕様書テンプレートを元に、構造化生成プロセスと
チェックリスト検証によって高品質なサービス仕様書を作成する。

## 入力情報

$ARGUMENTS

## 実行手順

### Phase 1: 入力・初期化

#### Step 1-1: プロダクト情報の取得

上記「入力情報」が空の場合は、
「プロダクトのビジョンまたは説明を入力してください。」
とだけ表示し、ユーザの次のメッセージを待て。

入力がある場合はそれをプロダクト情報として使用する。

#### Step 1-2: 不足情報ヒアリング

プロダクト情報を分析し、以下が不足・曖昧な場合は
ユーザに質問して明確化せよ:

- ターゲットユーザーの具体像
  （年齢層、居住地域、職業、利用シーン等）
- 主要ユーザー体験フロー
  （ユーザーがプロダクトを使う一連の流れ）
- 技術的制約
  （言語、フレームワーク、外部サービス、実行環境等）

十分に明確な場合はこのステップをスキップしてよい。

#### Step 1-3: ブランチ作成

対象リポジトリのルート（git rev-parse --show-toplevel）を
基準に、以下を実行する:

1. デフォルトブランチ（master または main）を最新化する

```bash
DEFAULT_BRANCH=$(git remote show origin 2>/dev/null | grep 'HEAD branch' | cut -d: -f2 | tr -d ' ')
git checkout "$DEFAULT_BRANCH"
git pull origin "$DEFAULT_BRANCH"
```

2. プロダクト情報からブランチ名用の slug を生成する
   - 最大30文字の全小文字ケバブケース英数字（a-z, 0-9, ハイフンのみ）
3. `docs/spec-<slug>` ブランチを作成・チェックアウトする

```bash
git checkout -b "docs/spec-<slug>"
```

#### Step 1-4: テンプレートのコピー

1. docs/ ディレクトリが存在しない場合は作成する
2. ~/projects/vdev/templates/service-spec/service-spec.md を
   対象リポジトリの docs/service-spec.md にコピーする
3. コピー後、テンプレートを Read ツールで読み込む

### Phase 2: 基盤セクション起草

テンプレートの各セクションを以下の順序で起草する。
先行セクションの内容を参照しながら記述すること。

1. §1 サービス概要（§1.1〜§1.4）
   - §1.1: プロダクトビジョンを一文で記述
   - §1.2: 解決する課題を列挙
   - §1.3: ターゲットユーザーを具体的に記述
   - §1.4: ユーザー体験の全体像をステップで記述

2. §5 技術アーキテクチャ
   - §5.1: 技術スタックと選定理由
   - §5.2: システム構成

3. §6 ドメイン設計
   - プロダクト固有の設計要素を記述
   - ビジネスルール・閾値定義があれば明記

4. §7 データ設計
   - §7.1: 主要エンティティ
   - §7.2: データ取得・管理戦略（該当時のみ）

5. §8 運用設計
   - §8.1: ディレクトリ構成
   - §8.2: gitignore 設計
   - §8.3: ログ設計（3要件必須）

6. §3 スコープ外要件
   - §1〜§8 の内容を踏まえ、
     明示的に対応しない要件を列挙

起草した内容を docs/service-spec.md に書き込む。

### Phase 3: E2Eテスト要件の体系的導出（§2）

本 Phase はスキップ禁止。
以下の中間ステップを必ず経由すること。

#### Step 3-1: ユーザー機能の列挙

§1.4 のユーザー体験フローから
独立したユーザー機能を列挙する。

出力形式:
| # | ユーザー機能 | 対応する §1.4 のステップ |
|---|-------------|------------------------|
| 1 | {機能名}    | {ステップ番号・内容}    |

#### Step 3-2: 条件軸の列挙

§6 のドメイン設計から、各ユーザー機能の振る舞いを
変化させる条件軸を列挙する。

出力形式:
| ユーザー機能 | 条件軸 | 値の例 | 根拠（§6 の該当箇所） |
|-------------|--------|--------|----------------------|
| {機能名}    | {軸名} | {値}   | {§6 の記述}          |

#### Step 3-3: 具体的テストデータの導出

§1.3 のターゲットユーザー情報から、
条件軸に対する具体的テストデータを導出する。

ルール:
- 汎用的なダミーデータは禁止
- ドメイン固有の実データを使用すること
- §1.3 のターゲット情報（居住地域、職業、
  利用シーン等）に基づく具体値を導出する

出力形式:
| 条件軸 | テストデータ | 導出根拠（§1.3） |
|--------|-------------|-----------------|
| {軸名} | {具体値}    | {ターゲット情報} |

#### Step 3-4: テストケース生成

Step 3-1〜3-3 を統合して §2 のテーブルを生成する。

生成ルール:
- 各ユーザー機能に対し最低2ケース
  （基本ケース + 条件変動ケース）
- §6 に閾値定義がある場合、境界値テストを含める
- 異常系を最低1ケース含める
- 全ケースに Step 3-3 の具体テストデータを使用

生成した §2 テーブルで docs/service-spec.md を更新する。

中間成果物（Step 3-1〜3-3 の表）は
仕様書末尾に以下の形式で追記する:

---
## 付録: E2Eシナリオ導出過程

### A.1 ユーザー機能一覧（Step 3-1）
{Step 3-1 の出力}

### A.2 条件軸一覧（Step 3-2）
{Step 3-2 の出力}

### A.3 具体的テストデータ（Step 3-3）
{Step 3-3 の出力}
---

### Phase 4: 開発ロードマップ（§4）

以下の順序で §4 を起草する:

1. §4.1 必要な環境情報
   - 外部サービスの認証情報等、
     人間が事前に入手すべき環境情報を列挙
   - プレースホルダー値は記載禁止

2. §4.2 事前の人間タスク
   - 開発開始前に人間が完了すべきタスクを
     チェックリスト形式で列挙

3. §4.3 RFC一覧
   - 実装を分割するRFCの slug と概要を列挙
   - 最終行は必ず「全体E2Eテスト実施」RFCとする

起草した内容で docs/service-spec.md を更新する。

### Phase 5: チェックリスト検証

同一エージェント内で実行する。
別 Task は使わない。
以下を1項目ずつ YES/NO で検証する。

#### E2Eテスト品質チェック

- [ ] §2 のケース数 ≥ Step 3-1 のユーザー機能数 × 2
- [ ] Step 3-2 の主要条件軸が §2 でカバーされている
- [ ] §1.3 のターゲット情報から導かれる
      ドメイン固有データが §2 に出現する
- [ ] §6 に閾値定義がある場合、
      その境界値テストが §2 に存在する
- [ ] 異常系テストが最低1件存在する
- [ ] 各テストケースの期待結果が
      プログラムから検証可能な形式である

#### 仕様書構造チェック

- [ ] §4.3 の最終行が
      「全体E2Eテスト実施」RFCである
- [ ] §4.1 にプレースホルダー値が含まれていない
- [ ] §8.3 がファイル出力・ローテーション・
      構造化ログの3要件を満たす
- [ ] §2 にモック・スタブ・スパイ関連用語が
      含まれていない

FAIL 項目がある場合:
1. FAIL 項目をまとめて修正する
2. 修正後に再検証する
3. 全項目 YES になるまで繰り返す

### Phase 6: チェックリスト結果サマリの出力

Phase 5 のチェックリスト結果を
以下の形式でユーザに報告する:

チェックリスト検証結果:

E2Eテスト品質:
- {項目}: {YES/NO}
- ...

仕様書構造:
- {項目}: {YES/NO}
- ...

修正回数: {N}回
最終結果: 全項目 PASS

### Phase 7: コミット & PR 作成

1. 変更ファイルをステージングする
2. コミットメッセージ:
   `docs: add service spec for {プロダクト名}`
3. リモートにプッシュする

```bash
git push -u origin docs/spec-<slug>
```

4. PR を作成する

```bash
gh pr create --title "docs: add service spec for {プロダクト名}" --body "$(cat <<'EOF'
## Summary
- サービス仕様書を新規作成
- E2Eテスト要件は Three-Tier Method で体系的に導出済み
- チェックリスト検証で品質確認済み

## Checklist
- [ ] §1 サービス概要の妥当性
- [ ] §2 E2Eテスト要件の網羅性
- [ ] §4.3 RFC分割粒度の妥当性
- [ ] §6 ドメイン設計の業務ルール正確性
EOF
)"
```

5. 以下をユーザに報告する:

```
サービス仕様書の作成が完了しました。

- **ファイル**: docs/service-spec.md
- **ブランチ**: docs/spec-<slug>
- **PR**: {PR URL}

人間による最終確認・マージをお願いします。
```
```

### 設計2: コマンド定義の設計判断

- 7 Phase 構成は自動開発パイプラインの上流として設計されている
- Phase 3 の Three-Tier Method がE2Eテスト品質の主エンジンである
  - Tier 1: 構造化入力（§1.4 → ユーザー機能列挙）
  - Tier 2: 条件軸展開（§6 → テスト条件の体系的導出）
  - Tier 3: 具体データ（§1.3 → ドメイン固有テストデータ）
- Phase 5 はホリスティック自由記述レビューではなく、チェックリスト分解型検証を採用している
- Task 分割を行わず全て同一エージェント内で完結させる理由は、コンテキスト共有コストの削減である

### 単体テスト仕様

| テスト対象 | 検証観点 |
|-----------|----------|
| コマンド定義 Phase 1 | プロダクト情報の取得手順が記述されていること |
| コマンド定義 Phase 1 | 不足情報ヒアリングの3項目（ターゲット、UXフロー、技術制約）が記述されていること |
| コマンド定義 Phase 1 | テンプレートコピー手順が記述されていること |
| コマンド定義 Phase 2 | 基盤セクションの起草順序が §1→§5→§6→§7→§8→§3 であること |
| コマンド定義 Phase 3 | Step 3-1〜3-4 の4ステップが記述されていること |
| コマンド定義 Phase 3 | 各ステップの出力形式（テーブル）が定義されていること |
| コマンド定義 Phase 3 | 中間成果物を付録として残す手順が記述されていること |
| コマンド定義 Phase 3 | 生成ルール（最低2ケース、境界値、異常系、具体データ）が明記されていること |
| コマンド定義 Phase 4 | §4.3 の最終行が全体E2Eテスト実施RFCであるルールが記述されていること |
| コマンド定義 Phase 5 | E2Eテスト品質チェック6項目が記述されていること |
| コマンド定義 Phase 5 | 仕様書構造チェック4項目が記述されていること |
| コマンド定義 Phase 5 | FAIL 時の修正→再検証ループが記述されていること |
| コマンド定義 Phase 5 | 同一エージェント内実行の指示が記述されていること |
| コマンド定義 Phase 6 | チェックリスト結果サマリの出力形式が定義されていること |
| コマンド定義 Phase 7 | コミット・プッシュ手順が記述されていること |
| コマンド定義全体 | Task 分割・別エージェント呼び出しの指示が含まれていないこと |
