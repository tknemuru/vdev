# [RFC] E2Eテスト仕様への移行と機械的バリデーションの導入

| 項目 | 内容 |
| :--- | :--- |
| **作成者 (Author)** | AI (Claude) |
| **ステータス** | Draft (起草中) |
| **作成日** | 2026-02-27 |
| **タグ** | testing, workflow, quality |
| **関連リンク** | docs/reports/20260227-report-service-spec-template-analysis.md |

<!-- 記述形式ルール（全セクション共通）:
1. 80文字上限: 1箇条書き項目・1テーブルセルは80文字以内
   80文字に収まらない場合はサブ項目分割またはテーブル行分割
2. 散文禁止（例外あり）:
   §1のみ散文許可（5文以内）
   §11のコードブロック間補足は2文以内の散文許可
3. §1-5 コード識別子禁止:
   バッククォートで囲まれたコード識別子の使用を禁止
   （ファイル名、関数名、変数名、パス、コマンド）
   機能名称またはドメイン用語で記述すること
-->

## 1. 背景・動機 (Motivation)

LINE通知未送信問題の調査により、RFCの検証設計に構造的欠陥が判明した。結合テスト仕様の全項目がモック付きユニットテストレベルに留まり、実環境でのE2E検証が一切含まれていなかった。全7件のRFCが自動開発で完了したにもかかわらず、LINE通知は一度も実際に送信されていない。過去に複数回の対策（テンプレート改善、レビュー基準追加、検証コマンド分離）を実施したが、いずれも「AIへの指示を工夫する」アプローチであり、AIの手抜きバイアスに対する根本的解決には至っていない。本RFCでは、テンプレート構造の強制・機械的バリデーション・レビュー基準の刷新により、構造的にE2Eテストの品質を担保する。

## 2. 機能要件

### 達成すべき要件

| ID | 要件 |
|----|------|
| FR-1 | RFCテンプレートのセクション7を「E2Eテスト仕様」に再定義する |
| FR-2 | E2Eテスト仕様のテーブル列構造を5列に変更する |
| FR-3 | テンプレートにOK/NG例と禁止事項のコメントを追加する |
| FR-4 | RFCレビューコマンドにバリデーションステップを新設する |
| FR-5 | 禁止用語スキャン機能を実装する |
| FR-6 | テーブル構造検証機能を実装する |
| FR-7 | 外部連携要件のE2Eテストカバレッジ検証機能を実装する |
| FR-8 | 自動RFCコマンドのループ制御を2カウンター方式に変更する |
| FR-9 | 検証コマンドをE2Eテスト仕様に対応させる |
| FR-10 | レビュー基準のアプローチレビュアーセクションを更新する |
| FR-11 | 関連ドキュメント全体の用語を統一する |
| FR-12 | タスク計画にセットアップタスクの注記を追加する |

### やらないこと

- 既存の過去RFC（既にマージ済みのもの）の改修
- 人間介入の増加を伴う変更
- 全自動フロー（自動RFC・自動実装・自動開発）の阻害

## 3. 非機能要件

### 達成すべき要件

| ID | 分類 | 要件 |
|----|------|------|
| NF-1 | 互換性 | 自動RFC・自動実装・自動開発の全自動フローが阻害されないこと |
| NF-2 | 運用性 | バリデーション失敗時の修正指示が具体的であること |
| NF-3 | コスト | バリデーション失敗時にレビュアーを起動しないこと |

### やらないこと

- バリデーションのための外部ツール・ライブラリの導入

## 4. 実現方式

| 要件 | 実現方式 |
|------|----------|
| FR-1, FR-2, FR-3 | RFCテンプレートのセクション7を書き換える |
| FR-4, FR-5, FR-6, FR-7 | RFCレビューコマンド定義にステップ4.5を追加する |
| FR-8 | 自動RFCコマンド定義のループ制御ロジックを書き換える |
| FR-9 | 検証コマンド定義の用語・手順・列構造を更新する |
| FR-10 | レビュー検証項目定義のアプローチレビュアーセクションを更新する |
| FR-11 | RFC作成コマンド・ワークフロー定義・検証コマンドの用語を統一する |
| FR-12 | RFCテンプレートのセクション9注記にセットアップタスク指示を追加する |
| NF-1 | バリデーション失敗を既存ループ制御と統合する |
| NF-2 | バリデーション失敗時に修正指示ファイルを書き出す |
| NF-3 | バリデーション失敗時はレビュアー起動前にリターンする |

## 5. 代替案の検討

| 案 | 概要 | 採否 | 決定的理由 |
|----|------|------|------------|
| A: 構造的バリデーション | テンプレート強制+機械的チェック+基準刷新の3層防御 | **採用** | AIの判断力に依存せず構造で品質を担保できる |
| B: レビュー基準強化のみ | レビュアーの検証項目を厳格化し判断に委ねる | 却下 | 過去の対策と同じ「指示の工夫」アプローチであり根本解決にならない |
| C: 外部バリデーションツール導入 | 専用スクリプトでRFCの静的解析を実行する | 却下 | コマンド定義の自然言語チェックで十分であり、ツール保守コストが不要 |

## 6. 外部仕様 (External Specification)

- RFCテンプレートのセクション7の名称が「結合テスト仕様」から「E2Eテスト仕様」に変わる
- E2Eテスト仕様のテーブルが5列構成（ID、対応要件、セットアップ手順、実行手順、期待するアウトカム）になる
- テンプレートコメントにOK/NG例と禁止事項が記載される
- RFCレビュー実行時、レビュアー起動前にバリデーションが自動実行される
  - 違反時はレビュアーが起動されず、修正指示ファイルが出力される
- 自動RFCでは、バリデーション失敗とレビュー指摘が独立したカウンターで管理される
  - バリデーション試行は最大5回
  - レビューイテレーションは最大3回（従来と同じ）
- 検証コマンド実行時、E2Eテスト仕様のセットアップ手順が充足されているか事前確認される
- Task計画にセットアップ種別のタスクを含める規約が追加される

## 7. E2Eテスト仕様

<!-- E2Eテストの操作的定義:
ユーザまたは運用者の操作を起点とし、最終的なアウトカム
（ユーザが得る結果）の確認までを一貫して行うシナリオテスト。

OK例:
- CLI で notify を実行し、LINE アプリに通知が届く
- cron スクリプトを実行し、ログに SUCCESS が記録され通知が届く

NG例:
- LINE API にリクエストを送信しレスポンスコードを確認する
- DB に SELECT してレコードが存在することを確認する
- メッセージ構築関数の出力 JSON を確認する

禁止事項:
モック/スタブ/テストフレームワーク経由の実行/内部動作の検証
-->

| ID | 対応要件 | セットアップ手順 | 実行手順 | 期待するアウトカム |
|----|----------|------------------|----------|-------------------|
| T-1 | FR-1, FR-2 | vdev リポジトリをチェックアウトする | テンプレートのセクション7を確認する | 名称が「E2Eテスト仕様」であり5列構成である |
| T-2 | FR-3 | vdev リポジトリをチェックアウトする | セクション7のコメントを確認する | OK/NG例と禁止事項がコメントに記載されている |
| T-3 | FR-4, FR-5 | テスト用RFCのセクション7に「mock」を記載する | RFCレビューコマンドを実行する | 「VALIDATION_FAIL」が返される |
| T-4 | FR-6 | テスト用RFCのセクション7に旧4列テーブルを記載する | RFCレビューコマンドを実行する | 構造違反で「VALIDATION_FAIL」が返される |
| T-5 | FR-7 | セクション2に外部連携要件を記載しセクション7に未対応とする | RFCレビューコマンドを実行する | カバレッジ不足で「VALIDATION_FAIL」が返される |
| T-6 | FR-8 | テスト用RFCを用意する | バリデーション失敗2回とレビュー指摘1回を発生させる | 2つのカウンターが独立して動作する |
| T-7 | FR-9 | E2E対応済みRFCと実装コードを用意する | 検証コマンドを実行する | セットアップ検証とE2Eテスト項目が処理される |
| T-8 | FR-10 | vdev リポジトリをチェックアウトする | アプローチレビュアーセクションを確認する | 旧3項目が削除されE2E基準2項目が記載されている |
| T-9 | FR-11 | vdev リポジトリをチェックアウトする | 対象ファイル群の用語を検索する | 「結合テスト仕様」が「E2Eテスト仕様」に統一 |
| T-10 | FR-12 | vdev リポジトリをチェックアウトする | セクション9の注記コメントを確認する | セットアップタスクの注記が記載されている |
| T-11 | NF-1 | 変更適用済みのvdevリポジトリを用意する | 全自動コマンド定義を確認する | 全自動フローの実行手順に破綻がない |

## 8. ドキュメント編集仕様

| 対象ファイル | 操作 | 変更内容 |
|-------------|------|----------|
| RFCテンプレート | 更新 | セクション7の名称・列構造・コメント変更、セクション9注記追加 |
| RFC作成コマンド定義 | 更新 | DoD自己チェックの「結合テスト仕様」を「E2Eテスト仕様」に変更 |
| RFCレビューコマンド定義 | 更新 | ステップ4.5（機械的バリデーション）の新設 |
| 自動RFCコマンド定義 | 更新 | ループ制御を2カウンター方式に変更 |
| 検証コマンド定義 | 更新 | 用語変更、ステップ構成変更、列名変更 |
| レビュー検証項目定義 | 更新 | アプローチレビュアーの結合テスト基準を刷新 |
| ワークフロー定義 | 更新 | ステージ3のDoDの用語統一 |
| システム概要ドキュメント | 対象外 | 本リポジトリに未配置のため影響なし |

## 9. Task計画

<!-- Phase/フェーズによる作業分割を禁止する。 -->
<!-- 全作業項目は単一のPRで完遂すること。 -->
<!-- §7 のセットアップ手順に記載した環境準備は本セクションに「セットアップ」種別のタスクとして含めること。 -->

| # | 種別 | 作業内容 | 依存 |
|---|------|----------|------|
| 1 | コード | RFCテンプレートのセクション7を更新する（名称・列構造・コメント） | - |
| 2 | コード | RFCテンプレートのセクション9に注記コメントを追加する | 1 |
| 3 | コード | RFCレビューコマンド定義にステップ4.5を追加する | 1 |
| 4 | コード | 自動RFCコマンド定義のループ制御を2カウンター方式に変更する | 3 |
| 5 | コード | 検証コマンド定義を更新する（用語・手順・列名） | 1 |
| 6 | コード | レビュー検証項目のアプローチレビュアーセクションを更新する | 1 |
| 7 | コード | RFC作成コマンド・ワークフロー定義・検証コマンドの用語を統一する | 1 |

### ロールバック基準と手順

- 自動RFC・自動実装・自動開発コマンドが正常実行できなくなった場合
- `git revert` で本PRのコミットを取り消し、旧定義に復帰する

## 10. 前提条件・依存関係

| 種別 | 内容 |
|------|------|
| 前提 | 既存の全自動フロー（自動RFC・自動実装・自動開発）の動作仕様を理解していること |
| 前提 | 過去RFCの改修は行わないこと |
| 依存 | なし（vdev リポジトリ内の定義ファイルのみ変更） |

## 11. 詳細設計 (Detailed Design)

### 改革1: RFCテンプレート セクション7の再定義

RFCテンプレートのセクション7を以下のように書き換える。

```markdown
## 7. E2Eテスト仕様

<!-- E2Eテストの操作的定義:
ユーザまたは運用者の操作を起点とし、最終的なアウトカム
（ユーザが得る結果）の確認までを一貫して行うシナリオテスト。

OK例:
- CLI で notify を実行し、LINE アプリに通知が届く
- cron スクリプトを実行し、ログに SUCCESS が記録され通知が届く

NG例:
- LINE API にリクエストを送信しレスポンスコードを確認する
- DB に SELECT してレコードが存在することを確認する
- メッセージ構築関数の出力 JSON を確認する

禁止事項:
モック/スタブ/テストフレームワーク経由の実行/内部動作の検証
-->

| ID | 対応要件 | セットアップ手順 | 実行手順 | 期待するアウトカム |
|----|----------|------------------|----------|-------------------|
| {ID} | {要件ID} | {環境準備手順} | {操作手順} | {ユーザが得る最終結果} |
```

### 改革1補足: セクション9の注記追加

RFCテンプレートのセクション9のコメントに以下を追加する。

```markdown
<!-- §7 のセットアップ手順に記載した環境準備は本セクションに「セットアップ」種別のタスクとして含めること。 -->
```

### 改革2: RFCレビューコマンドへのバリデーション追加

RFCレビューコマンド定義のステップ4（ラウンド判定）とステップ5（並列レビュー実行）の間にステップ4.5を新設する。

```markdown
### Step 4.5: 機械的バリデーション

RFC ファイルのセクション7に対し、以下の3つのチェックを実施せよ。

#### チェック1: 禁止用語スキャン

セクション7（コメント部分を除く本文）に以下の用語が含まれていないことを確認する:

- モック, スタブ, スパイ
- mock, stub, spy
- jest, vitest
- テストフレームワーク, test framework
- describe(, it(, expect(

#### チェック2: テーブル構造検証

セクション7のテーブルヘッダーが以下の5列を持つことを確認する:

- ID, 対応要件, セットアップ手順, 実行手順, 期待するアウトカム

#### チェック3: 外部連携要件のカバレッジ

1. セクション2（機能要件）から外部連携を伴う要件を抽出する
   - 外部API呼び出し、外部サービス連携、通知送信等を含む要件
2. セクション7に、抽出した各外部連携要件に対応するE2Eテスト項目が
   存在するか確認する

#### バリデーション結果の処理

- 全チェック通過: Step 5（並列レビュー実行）に進む
- いずれかの違反あり:
  1. ステータス「VALIDATION_FAIL」を返す
  2. `docs/rfcs/<slug>/validation-r{round}.md` に修正指示を書き出す
     - 違反内容（どのチェックが失敗したか）
     - 該当箇所の引用
     - 具体的な修正指示
  3. Step 5 には進まない（レビュアーは起動しない）
```

### 改革3: 自動RFCコマンドの2カウンター方式

自動RFCコマンドのレビューループ（Phase 2）を以下のロジックに変更する。

```markdown
### Phase 2: レビューループ

2つの独立したカウンターでループを制御する:
- `validation_attempts`: バリデーション試行回数（上限5回）
- `review_iterations`: レビューイテレーション回数（上限3回）

#### Step 2-1: レビュー実行（/rrfc 呼び出し）

（既存と同じ内容で /rrfc を Task 経由で呼び出す）

#### Step 2-2: 判定

Task の結果からステータスを確認する。

- **Approve の場合**: レビューループ完了。Phase 3 へ進む。
- **VALIDATION_FAIL の場合**:
  - `validation_attempts` をインクリメントする
  - `validation_attempts` >= 5 の場合:
    「バリデーション試行が上限（5回）に達しました。
    修正指示を確認し、手動で対応してください。」と報告して終了
  - `validation_attempts` < 5 の場合: Step 2-3 へ進む
- **Request Changes の場合**:
  - `review_iterations` をインクリメントする
  - `review_iterations` >= 3 の場合:
    「レビューイテレーションが上限（3回）に達しました。
    アクションプランを確認し、手動で対応してください。」と報告して終了
  - `review_iterations` < 3 の場合: Step 2-3 へ進む

#### Step 2-3: RFC 修正（/urfc 呼び出し）

（既存と同じ内容で /urfc を Task 経由で呼び出す。
VALIDATION_FAIL の場合は修正指示ファイルもコンテキストとして渡す）
```

### 改革4: 検証コマンドのE2E対応

検証コマンド定義に対する変更内容を示す。

- 冒頭の説明文: 「結合テスト仕様」を「E2Eテスト仕様」に変更
- Step 3: 抽出対象の列名を変更
  - 旧: ID、対応要件、テスト内容、期待結果
  - 新: ID、対応要件、セットアップ手順、実行手順、期待するアウトカム
- Step 4:
  - 項目1「対応する実装が存在するか確認する」を削除
  - セットアップ検証を追加: 各E2Eテスト項目のセットアップ手順が充足されているか確認する（環境変数の存在確認等）
- Step 5:
  - 注意書き「目視確認」「記載があること」等の確認は〜」を削除
  - 注意書き「〜を追記済み」「〜を実装済み」はエビデンスとして認めない」を削除
- Step 6: 結果テーブルの列名を新テンプレートに合わせる

### 改革5: アプローチレビュアーの検証基準更新

レビュー検証項目のアプローチレビュアーセクションから、以下の旧基準3項目を削除する。

- 「検討する」「評価する」等の曖昧な記述チェック
- トートロジー的な期待結果チェック
- 実行可能なテスト内容チェック

以下のE2E固有P0基準2項目に置換する。

```markdown
- E2Eテスト仕様の各テストが要件に対応しているか。以下に該当する場合は P0 として指摘すること:
  - 期待するアウトカムが最終的なユーザ結果ではなく中間処理の確認になっている
  - セットアップ手順に環境準備が記載されていない（外部連携要件であるにもかかわらず）
```

### 改革6: 用語統一

以下の箇所の「結合テスト仕様」を「E2Eテスト仕様」に変更する。

- RFC作成コマンド定義のステップ7 DoD自己チェック
- ワークフロー定義のステージ3 DoD
- 検証コマンド定義の冒頭説明文

### 単体テスト仕様

| テスト対象 | 検証観点 |
|-----------|----------|
| RFCテンプレート セクション7 | 5列構造とコメント（OK/NG例・禁止事項）が正しいこと |
| RFCテンプレート セクション9 | セットアップタスク注記が存在すること |
| RFCレビューコマンド ステップ4.5 | 3つのチェック手順が記載されていること |
| RFCレビューコマンド ステップ4.5 | バリデーション失敗時の処理フローが正しいこと |
| 自動RFCコマンド Phase 2 | 2カウンター方式のロジックが正しいこと |
| 検証コマンド Step 3 | 抽出列名が新テンプレートと一致すること |
| 検証コマンド Step 4 | 旧項目1が削除されセットアップ検証が追加されていること |
| 検証コマンド Step 5 | 旧注意書き2件が削除されていること |
| レビュー検証項目 | 旧基準3項目が削除されE2E基準2項目が存在すること |
| 用語統一 | 対象3箇所すべてが「E2Eテスト仕様」に変更されていること |
