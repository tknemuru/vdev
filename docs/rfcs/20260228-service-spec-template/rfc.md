# [RFC] サービス仕様書テンプレート作成と自動開発コマンド前提条件ゲート

| 項目 | 内容 |
| :--- | :--- |
| **作成者 (Author)** | AI (Claude) |
| **ステータス** | Accepted (承認済) |
| **作成日** | 2026-02-28 |
| **タグ** | template, service-spec, adev, quality |
| **関連リンク** | docs/reports/20260227-report-service-spec-template-analysis.md |

<!-- 記述形式ルール（全セクション共通）:
1. 80文字上限: 1箇条書き項目・1テーブルセルは80文字以内
   80文字に収まらない場合はサブ項目分割またはテーブル行分割
2. 散文禁止（例外あり）:
   §1のみ散文許可（5文以内）
   §11のコードブロック間補足は2文以内の散文許可
   他セクションは散文禁止でテーブルまたは箇条書きのみ
3. §1-5 コード識別子禁止:
   バッククォートで囲まれたコード識別子の使用を禁止
   （ファイル名、関数名、変数名、パス、コマンド）
   機能名称またはドメイン用語で記述すること
-->

## 1. 背景・動機 (Motivation)

<!-- 散文で記述。ただし5文以内。 -->

サービス仕様書テンプレート調査レポートで9章構成のテンプレートが提案されたが、レビュー指摘により構成の見直しが必要となった。自動開発で構築したプロダクトの品質問題として、単体テストのみでモック・スタブだらけの実装が散見され、E2Eテスト要件の明示が不可欠である。また、事前に人間が準備すべき環境情報やタスクが未完了のまま自動開発が進行し、AIがモック値やダミー値で代替する問題が発生している。テンプレートに「禁止」と記載しても自動開発コマンド側にゲートがなければスルーされるため、機械的検証の組み込みが必要である。本RFCでは、レビュー指摘を反映した8章構成テンプレートの新規作成と、自動開発コマンドへの前提条件ゲート追加を提案する。

## 2. 機能要件

### 達成すべき要件

<!-- コード識別子禁止。機能名称またはドメイン用語で記述。 -->

| ID | 要件 |
|----|------|
| FR-1 | 8章構成のサービス仕様書テンプレートを新規作成する |
| FR-2 | 「変更履歴」章を削除する |
| FR-3 | 機能要件章をE2Eテスト要件章に変更する |
| FR-4 | E2Eテスト要件のテーブル列を5列構成とする |
| FR-5 | 開発ロードマップの最終RFCを全体E2Eテスト実施RFCとするルールを明記する |
| FR-6 | スコープ外を独立章として分離する |
| FR-7 | 開発ロードマップに必要な環境情報セクションを追加する |
| FR-8 | 開発ロードマップに事前の人間タスクセクションを追加する |
| FR-9 | 外部インターフェース設計の独立章を廃止する |
| FR-10 | 開発ロードマップから依存関係図と実装完了の定義を削除する |
| FR-11 | リスクと対策章を削除する |
| FR-12 | ログ設計を必須化し3要件を明記する |
| FR-13 | gitignore設計に同期管理ファイルと個人情報ファイルの除外原則を明記する |
| FR-14 | 自動開発コマンドのデフォルトRFC一覧セクションを変更する |
| FR-15 | 自動開発コマンドに前提条件ゲートステップを追加する |

### やらないこと

- 既存サービス仕様書（過去に作成済みのもの）の改修
- 自動開発コマンド以外のコマンド定義の変更
- テンプレート利用ガイドや運用マニュアルの作成

## 3. 非機能要件

### 達成すべき要件

| ID | 分類 | 要件 |
|----|------|------|
| NF-1 | 互換性 | 自動開発コマンドの既存フローが阻害されないこと |
| NF-2 | 運用性 | 前提条件ゲート失敗時にどの項目が未完了か明示されること |
| NF-3 | 安全性 | 前提条件未充足時は後続処理に進まないfail-closed設計であること |

### やらないこと

- 前提条件ゲートの自動修復機能
- テンプレートのバリデーションツールの作成

## 4. 実現方式

<!-- 機能要件・非機能要件をどう実現するかの高レベル方針。 -->

| 要件 | 実現方式 |
|------|----------|
| FR-1〜FR-13 | テンプレートファイルを新規作成し8章構成で配置する |
| FR-14 | 自動開発コマンド定義のデフォルトセクションを書き換える |
| FR-15, NF-2, NF-3 | 自動開発コマンド定義のStep 2に前提条件ゲートを挿入する |
| NF-1 | 既存のStep 2以降の処理フローを維持する |

## 5. 代替案の検討

<!-- §4の実現方式に対する代替案。最低2案を比較。 -->

| 案 | 概要 | 採否 | 決定的理由 |
|----|------|------|------------|
| A: コマンド定義内ゲート | 自動開発コマンド定義に前提条件チェックロジックを自然言語で記述する | **採用** | 外部スクリプト不要で保守コストが低い |
| B: 外部バリデーションスクリプト | シェルスクリプトで前提条件を検証し自動開発コマンドから呼び出す | 却下 | スクリプトの保守コストが発生し、テンプレート変更のたびにスクリプトも修正が必要 |
| C: ゲートなし（テンプレート記載のみ） | テンプレートのコメントで「禁止」と記載するだけでゲートは設けない | 却下 | 過去に同種の問題が発生しており、AIが無視することが実証済み |

## 6. 外部仕様 (External Specification)

<!-- ユーザ・運用者視点の振る舞い。箇条書き＋コード例。 -->

- サービス仕様書テンプレートが `templates/service-spec/service-spec.md` に配置される
- テンプレートの章構成が8章になる:
  1. サービス概要
  2. E2Eテスト要件
  3. スコープ外要件
  4. 開発ロードマップ
  5. 技術アーキテクチャ
  6. ドメイン設計
  7. データ設計
  8. 運用設計
- 自動開発コマンドのデフォルトRFC一覧セクションが「4.3」になる
- 自動開発コマンド実行時、RFC一覧パース前に前提条件が検証される
  - 環境情報セクションの設定先ファイル存在確認とプレースホルダー検出
  - 人間タスクチェックリストの未チェック項目検出
  - いずれかの違反で処理が終了する

## 7. E2Eテスト仕様

<!-- E2Eテストの操作的定義:
ユーザまたは運用者の操作を起点とし、最終的なアウトカム
（ユーザが得る結果）の確認までを一貫して行うシナリオテスト。

OK例:
- CLI で notify を実行し、LINE アプリに通知が届く
- cron スクリプトを実行し、ログに SUCCESS が記録され通知が届く

NG例:
- LINE API にリクエストを送信しレスポンスコードを確認する
- DB に SELECT してレコードが存在することを確認する
- メッセージ構築関数の出力 JSON を確認する

禁止事項:
モック/スタブ/テストフレームワーク経由の実行/内部動作の検証
-->

| ID | 対応要件 | セットアップ手順 | 実行手順 | 期待するアウトカム |
|----|----------|------------------|----------|-------------------|
| T-1 | FR-1 | vdevリポジトリをチェックアウトする | テンプレートファイルの存在を確認する | テンプレートが所定パスに存在する |
| T-2 | FR-2 | テンプレートを開く | 変更履歴セクションを検索する | 変更履歴セクションが存在しない |
| T-3 | FR-3, FR-4 | テンプレートを開く | E2Eテスト要件セクションを確認する | 5列テーブル（ID, シナリオ名, 前提条件, 実行手順, 期待結果）がある |
| T-4 | FR-5 | テンプレートを開く | 開発ロードマップのルール記述を確認する | 最終RFCは全体E2Eテスト実施RFCとするルールが明記されている |
| T-5 | FR-6 | テンプレートを開く | スコープ外要件セクションを確認する | 独立した章（§3）として存在する |
| T-6 | FR-7, FR-8 | テンプレートを開く | 開発ロードマップ内を確認する | 必要な環境情報（§4.1）と事前の人間タスク（§4.2）が存在する |
| T-7 | FR-9 | テンプレートを開く | 外部インターフェース設計の独立章を検索する | 独立章が存在しない |
| T-8 | FR-10 | テンプレートを開く | 開発ロードマップ内を確認する | 依存関係図と実装完了の定義が存在しない |
| T-9 | FR-11 | テンプレートを開く | リスクと対策セクションを検索する | リスクと対策セクションが存在しない |
| T-10 | FR-12 | テンプレートを開く | ログ設計セクションを確認する | 3要件（ファイル出力、ローテーション、JSON構造化ログ）が明記されている |
| T-11 | FR-13 | テンプレートを開く | gitignore設計セクションを確認する | 同期管理ファイルと個人情報ファイルの除外原則が明記されている |
| T-12 | FR-14 | 自動開発コマンド定義を開く | デフォルトセクション名を確認する | デフォルトが「4.3」になっている |
| T-13 | FR-15, NF-3 | テスト用仕様書を用意する（環境情報に存在しないファイルパスを記載） | 自動開発コマンドの手順に従い前提条件ゲートを評価する | ゲートで処理が停止し、未充足項目が報告される |
| T-14 | FR-15, NF-3 | テスト用仕様書を用意する（人間タスクに未チェック項目を含む） | 自動開発コマンドの手順に従い前提条件ゲートを評価する | ゲートで処理が停止し、未チェック項目が報告される |
| T-15 | FR-15, NF-2 | テスト用仕様書を用意する（環境情報にプレースホルダーを記載） | 自動開発コマンドの手順に従い前提条件ゲートを評価する | ゲートで処理が停止し、プレースホルダーが検出される |
| T-16 | NF-1 | 全前提条件を充足したテスト用仕様書を用意する | 自動開発コマンドの手順に従い前提条件ゲートを評価する | ゲートを通過しRFC一覧のパースに進む |

## 8. ドキュメント編集仕様

<!-- システム概要ドキュメント等の作成・更新・削除。 -->

| 対象ファイル | 操作 | 変更内容 |
|-------------|------|----------|
| サービス仕様書テンプレート | 作成 | 8章構成のテンプレートを新規配置 |
| 自動開発コマンド定義 | 更新 | デフォルトセクション変更と前提条件ゲート追加 |
| システム概要ドキュメント | 対象外 | 本リポジトリに未配置のため影響なし |

## 9. Task計画

<!-- Phase/フェーズによる作業分割を禁止する。 -->
<!-- 全作業項目は単一のPRで完遂すること。 -->
<!-- §7 のセットアップ手順に記載した環境準備は本セクションに「セットアップ」種別のタスクとして含めること。 -->

| # | 種別 | 作業内容 | 依存 |
|---|------|----------|------|
| 1 | コード | サービス仕様書テンプレートを新規作成する | - |
| 2 | コード | 自動開発コマンド定義のデフォルトセクションを変更する | - |
| 3 | コード | 自動開発コマンド定義に前提条件ゲートステップを追加する | 1 |

### ロールバック基準と手順

- 自動開発コマンドが正常実行できなくなった場合
- `git revert` で本PRのコミットを取り消し、旧定義に復帰する

## 10. 前提条件・依存関係

| 種別 | 内容 |
|------|------|
| 前提 | テンプレート調査レポートで9章構成が提案済みであること |
| 前提 | E2Eテスト仕様への移行RFCが承認済みであること |
| 依存 | なし（vdevリポジトリ内の定義ファイルのみ変更） |

## 11. 詳細設計 (Detailed Design)

<!-- 箇条書き＋コード例。 -->
<!-- コードブロック間補足は2文以内の散文許可。 -->

### 設計1: サービス仕様書テンプレート

`templates/service-spec/service-spec.md` に以下の8章構成で配置する。

```markdown
# {プロダクト名} サービス仕様書

## 1. サービス概要

### 1.1 プロダクトビジョン

{プロダクトのビジョン・目指す世界観}

### 1.2 解決する課題

{ターゲットユーザーが抱える課題}

### 1.3 ターゲットユーザー

{想定するユーザー像}

### 1.4 ユーザー体験の全体像

{ユーザーの操作フロー・体験の概要}

## 2. E2Eテスト要件

<!-- 完成版プロダクト全体のE2Eテストシナリオを定義する。
「実行手順」はCLIコマンド実行・API呼び出し等の
自動実行可能な手順として記述すること。
人間の目視確認や主観的判断を実行手順に含めてはならない。 -->

| ID | シナリオ名 | 前提条件 | 実行手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| E2E-001 | {シナリオ名} | {前提条件} | {自動実行可能な手順} | {期待結果} |

## 3. スコープ外要件

<!-- 「やらないこと」を明示し、AIの過剰実装を防止する。 -->

- {あえてやらないこと}

## 4. 開発ロードマップ

### 4.1 必要な環境情報

<!-- AIがモック値やダミー値で代替することを禁止する。
すべての環境情報は人間が事前に取得し、
指定された設定先ファイルに記載してから
自動開発コマンドを実行すること。

記載形式:
- 物理名には実際の値を記入する（プレースホルダー禁止）
- 設定先ファイルはリポジトリルートからの相対パスで記載する -->

| 論理名 | 物理名 | 用途 | 設定先ファイル |
|--------|--------|------|---------------|
| {例: LINE Channel Secret} | {実際の値} | {用途} | {例: .env} |

### 4.2 事前の人間タスク

<!-- 自動開発コマンド実行前に人間が完了すべきタスク。
すべてチェック済みになるまで自動開発は開始できない。 -->

- [ ] {例: LINE Developers でチャネルを作成し、認証情報を取得する}

### 4.3 RFC一覧

<!-- 自動開発コマンドのパース対象テーブル。
最終RFCは必ず全体E2Eテスト実施RFCとすること。 -->

| slug | 概要 | 依存 |
|------|------|------|
| {slug} | {スコープ・概要} | {依存するslug} |
| e2e-full-test | 全体E2Eテスト実施 | {全RFCのslug} |

## 5. 技術アーキテクチャ

### 5.1 技術スタック

| カテゴリ | 技術 | 選定理由 |
|---------|------|----------|
| {カテゴリ} | {技術名} | {選定理由} |

### 5.2 システム構成

{システム構成図またはコンポーネント構成の説明}

## 6. ドメイン設計

<!-- プロダクト固有の設計（自由記述）。
アルゴリズム設計、エージェント構成、ビジネスルール、
外部インターフェース設計（CLI/API/通知/UI等）を
必要に応じて記述する。 -->

{ドメイン固有の設計内容}

## 7. データ設計

### 7.1 主要エンティティ

| エンティティ | 属性 | 説明 |
|-------------|------|------|
| {エンティティ名} | {主要属性} | {説明} |

### 7.2 データ取得・管理戦略

<!-- 該当する場合のみ記載。 -->

{データの取得元、保存方式、更新戦略}

## 8. 運用設計

### 8.1 ディレクトリ構成

{プロジェクトのディレクトリ構成}

### 8.2 gitignore設計

<!-- 以下の原則に従うこと:
1. csync管理ファイル（.claude/配下等）は
   gitignoreに含めないこと。
   csyncで同期されるファイルはバージョン管理対象とする。
2. 個人情報・秘匿情報を含むファイル（.env、
   認証情報ファイル等）は必ずgitignoreに含めること。 -->

| カテゴリ | 対象 | 理由 |
|---------|------|------|
| {カテゴリ} | {対象パターン} | {理由} |

### 8.3 ログ設計

<!-- 以下の3要件を必ず満たすこと:
1. ファイル出力: ログをファイルに出力する
2. ローテーション: サイズまたは日付ベースのローテーションを実装する
3. JSON構造化ログ: ログエントリをJSON形式で構造化する

参考実装: ~/projects/abel/src/helpers/logger.js
（ファイル出力・サイズローテーション・日付ローテーション・
JSON構造化ログを実装した参考例） -->

| 要件 | 仕様 |
|------|------|
| 出力先 | {ログディレクトリパス} |
| ローテーション | {サイズ/日付ベースのローテーション方式} |
| フォーマット | JSON構造化ログ |
| ログレベル | {DEBUG/INFO/WARN/ERROR} |
| 保持期間 | {保持日数} |
```

### 設計2: 自動開発コマンドのデフォルトセクション変更

自動開発コマンド定義の3箇所を `"6.1"` から `"4.3"` に変更する。

```markdown
- セクション名: 省略時は "4.3"。RFC一覧テーブルが記載されたセクション
```

```markdown
$ARGUMENTS から仕様書パスとセクション名（省略時は "4.3"）を取得する。
```

```markdown
2. 指定セクション（デフォルト "4.3"）からRFC一覧テーブルを読み取り、
```

### 設計3: 自動開発コマンドの前提条件ゲート

Step 2 の「仕様書の読み込みとRFC一覧の抽出」を再構成し、RFC一覧パース前に前提条件ゲートを挿入する。

```markdown
### Step 2: 仕様書の読み込みと前提条件ゲート

1. 仕様書ファイルを Read ツールで読み込む。
   ファイルが存在しない場合はエラーを報告して終了する。

2. **前提条件ゲート（fail-closed）**:
   以下のチェックをすべて実施し、
   いずれかの違反があれば未充足項目を報告して終了する。
   すべて通過した場合のみ手順3に進む。

   #### ゲート1: 必要な環境情報（§4.1）の検証

   §4.1のテーブルから各行を読み取り、以下を検証する:
   - 「設定先ファイル」列に記載されたファイルが
     リポジトリルートに存在すること
   - 「物理名」列の値が以下のプレースホルダー禁止パターンに
     該当しないこと:
     - `{` と `}` で囲まれた文字列
     - `<` と `>` で囲まれた文字列
     - `TODO`、`TBD`、`FIXME`、`xxx`、`dummy`、`placeholder`
       （大文字小文字不問）

   違反時の報告形式:
   ```
   前提条件ゲート: 環境情報の検証に失敗しました。

   | 行 | 論理名 | 違反内容 |
   |----|--------|----------|
   | {行番号} | {論理名} | {ファイル未存在 or プレースホルダー検出} |

   §4.1の環境情報を人間が設定してから再実行してください。
   ```

   #### ゲート2: 事前の人間タスク（§4.2）の検証

   §4.2のチェックリストから各項目を読み取り、
   未チェック（`- [ ]`）の項目がないことを検証する。

   違反時の報告形式:
   ```
   前提条件ゲート: 人間タスクの検証に失敗しました。

   未完了タスク:
   - [ ] {未チェック項目1}
   - [ ] {未チェック項目2}

   すべてのタスクを完了してから再実行してください。
   ```

3. 指定セクション（デフォルト "4.3"）からRFC一覧テーブルを
   読み取り、各エントリの以下を抽出する:
   - slug: RFCの識別子
   - scope: スコープまたは概要
   - depends_on: 依存するRFCのslugリスト（空の場合もある）

テーブル形式の差異（`RFC-NNN` + slug列、slugが直接識別子等）は
AIのコンテキスト理解で吸収する。
```

### 単体テスト仕様

| テスト対象 | 検証観点 |
|-----------|----------|
| テンプレート §1 | プロダクトビジョン・課題・ターゲット・UX全体像の4セクションが存在すること |
| テンプレート §2 | E2Eテスト要件の5列テーブル（ID, シナリオ名, 前提条件, 実行手順, 期待結果）であること |
| テンプレート §2 | 自動実行可能な手順のルールがコメントに記載されていること |
| テンプレート §3 | スコープ外要件が独立章であること |
| テンプレート §4.1 | 環境情報テーブルにプレースホルダー禁止ルールがコメントに記載されていること |
| テンプレート §4.2 | チェックリスト形式であること |
| テンプレート §4.3 | RFC一覧テーブルと最終RFC全体E2Eルールがコメントに記載されていること |
| テンプレート §5 | 技術スタック・システム構成の2セクションが存在すること |
| テンプレート §6 | ドメイン設計が自由記述セクションであること |
| テンプレート §7 | データ設計に主要エンティティとデータ取得戦略が存在すること |
| テンプレート §8.2 | csync管理ファイルのignore原則と個人情報ファイルのignore原則がコメントに記載されていること |
| テンプレート §8.3 | ログ設計の3要件（ファイル出力・ローテーション・JSON構造化ログ）がコメントに記載されていること |
| テンプレート §8.3 | 参考実装へのパス参照がコメントに記載されていること |
| テンプレート全体 | 変更履歴・外部IF独立章・リスクと対策・依存関係図・実装完了の定義が存在しないこと |
| 自動開発コマンド デフォルトセクション | 3箇所すべてが「4.3」に変更されていること |
| 自動開発コマンド 前提条件ゲート | ゲート1（ファイル存在確認+プレースホルダー検出）の手順が記載されていること |
| 自動開発コマンド 前提条件ゲート | ゲート2（チェックリスト未チェック検出）の手順が記載されていること |
| 自動開発コマンド 前提条件ゲート | 違反時に後続処理に進まないfail-closed設計であること |
