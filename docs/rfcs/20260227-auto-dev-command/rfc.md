# [RFC] 自動開発コマンドの新設

| 項目 | 内容 |
| :--- | :--- |
| **作成者 (Author)** | Claude (RFC Author) |
| **ステータス** | Accepted (承認済) |
| **作成日** | 2026-02-27 |
| **タグ** | commands, automation, orchestration |
| **関連リンク** | なし |

<!-- 記述形式ルール（全セクション共通）:
1. 80文字上限: 1箇条書き項目・1テーブルセルは80文字以内
   80文字に収まらない場合はサブ項目分割またはテーブル行分割
2. 散文禁止（例外あり）:
   §1のみ散文許可（5文以内）
   §11のコードブロック間補足は2文以内の散文許可
   他セクションは散文禁止でテーブルまたは箇条書きのみ
3. §1-5 コード識別子禁止:
   バッククォートで囲まれたコード識別子の使用を禁止
   （ファイル名、関数名、変数名、パス、コマンド）
   機能名称またはドメイン用語で記述すること
-->

## 1. 背景・動機 (Motivation)

<!-- 散文で記述。ただし5文以内。 -->

現行のワークフローでは、人間が仕様書で方針レベルの承認を済ませた後も、各RFCの作成・レビュー・実装・検証を個別のスラッシュコマンドで逐次実行する必要がある。仕様書に複数のRFCが記載されている場合、この手動オーケストレーションが大きなボトルネックとなる。仕様書のRFC一覧を入力として、RFC作成から実装完了・マージまでを全自動で順次実行するオーケストレーションコマンドを新設し、人間の介入なしにワークフロー全体を完遂可能にする。

## 2. 機能要件

### 達成すべき要件

<!-- コード識別子禁止。機能名称またはドメイン用語で記述。 -->

| ID | 要件 |
|----|------|
| F1 | 仕様書パスとRFC一覧セクション名を入力として受け取る |
| F2 | 仕様書のRFC一覧テーブルから各RFCエントリを抽出する |
|    | - slug、スコープ/概要、依存関係を取得する |
|    | - テーブル形式はプロジェクトごとに異なるため、AIのコンテキスト理解でパースする |
| F3 | 依存関係をトポロジカルソートし、実行順序を決定する |
|    | - 依存のないRFCから先に実行する |
|    | - 循環依存がある場合はユーザに報告して終了する |
| F4 | 各RFCについて以下を直列で順次実行する |
|    | - 自動RFCコマンドによるRFC作成・レビュー承認 |
|    | - RFC PRの自動スカッシュマージ |
|    | - 自動実装コマンドによる実装・検証・レビュー承認 |
|    | - 実装PRの自動スカッシュマージ |
| F5 | 2層リカバリーによるエラーハンドリングを行う |
|    | - Tier 1: 自動RFC・自動実装コマンド内部の3ラウンドレビューループ |
|    | - Tier 2: 失敗終了時のオーケストレータによる診断・再試行 |
| F6 | 各RFCの処理中に決定ログを生成・追記する |
| F7 | 全RFC完了時に一覧形式で完了報告する |
| F8 | 途中中断時に完了済み・中断・未着手のRFC一覧を報告する |

### やらないこと

- 自動RFCコマンド・自動実装コマンドの定義変更
- RFC間の並列実行（完全直列で実行する）
- 人間による中間承認（仕様書レビューで方針承認済み）

## 3. 非機能要件

### 達成すべき要件

| ID | 分類 | 要件 |
|----|------|------|
| N1 | 信頼性 | Tier 2リカバリーは最大2回まで試行し、超過時はエスカレーションする |
| N2 | 信頼性 | スタック検知条件を満たした場合は即座に人間エスカレーションする |
| N3 | トレーサビリティ | 決定ログに全フェーズの判断根拠を記録する |
| N4 | 安全性 | コマンド実行ポリシーに基づき全ステップを自動実行する |
| N5 | 保守性 | 既存コマンドの再利用により、新規ファイルは1ファイルのみとする |

### やらないこと

- 実行時間の上限制御（各サブコマンドの既存タイムアウトに委ねる）
- 永続的な進捗状態の管理（決定ログのみで対応する）

## 4. 実現方式

<!-- 機能要件・非機能要件をどう実現するかの高レベル方針。 -->

| 要件 | 実現方式 |
|------|----------|
| F1-F2 入力解析 | 仕様書をAIが読み込み、RFC一覧テーブルをコンテキスト理解でパースする |
| F3 依存関係解決 | 依存列をパースしてトポロジカルソートで実行順を算出する |
| F4 直列実行 | 各RFCに対し自動RFC→マージ→自動実装→マージを順次実行する |
| F5 2層リカバリー | 失敗モード別の診断・サブコマンド直接呼び出しによる再試行 |
| F6-F8 決定ログ・報告 | RFC単位の決定ログファイル生成と完了/中断報告 |
| N4 自動実行 | コマンド実行ポリシールールによりPRマージ等も確認なしで実行する |
| N5 1ファイル | コマンド定義ファイル1つのみ新設し、ロジックはコマンド記述で完結する |

## 5. 代替案の検討

<!-- §4の実現方式に対する代替案。最低2案を比較。 -->

| 案 | 概要 | 採否 | 決定的理由 |
|----|------|------|------------|
| A: コマンド定義ファイル1つで完結 | オーケストレーション全体をMarkdownのコマンド定義として記述し、既存コマンドをTask経由で再利用する | **採用** | 新規ファイル1つのみで済み、既存コマンドを変更せず、保守コストが最小 |
| B: シェルスクリプトによるオーケストレーション | シェルスクリプトで各コマンドをCLI経由で順次呼び出す | 却下 | AIのコンテキスト理解による仕様書パース・障害診断ができず、リカバリーロジックが複雑化する |
| C: 専用のオーケストレーションエンジン構築 | 状態機械やキューを用いた汎用オーケストレーションフレームワークを実装する | 却下 | 現時点では自動開発コマンドのみが用途であり、フレームワーク構築は過剰投資 |

## 6. 外部仕様 (External Specification)

<!-- ユーザ・運用者視点の振る舞い。箇条書き＋コード例。 -->

- ユーザは仕様書パスを指定してコマンドを実行する
  - セクション名はオプション（省略時は "6.1"）
- コマンドは仕様書からRFC一覧を抽出し、依存順に全自動で処理する
- 各RFCについてRFC作成→マージ→実装→マージを順次実行する
- 全RFC完了時にslug・PR URL・ステータスの一覧を報告する
- 途中中断時に完了済み・中断理由・未着手の一覧と決定ログパスを報告する

### 動作例（正常系）

```
ユーザ: /adev docs/specs/system-spec.md
→ 仕様書読み込み → RFC一覧抽出 → 依存順ソート
→ RFC-1: /arfc → マージ → /aimp → マージ → 進捗報告
→ RFC-2: /arfc → マージ → /aimp → マージ → 進捗報告
→ 全RFC完了報告（slug, RFC PR URL, 実装PR URL, Status）
```

### 動作例（リカバリー・中断）

```
→ RFC-3: /arfc → レビュー3ラウンド不収束（Tier 1失敗）
→ Tier 2: 残存P0診断 → /urfc + /rrfc 再試行
→ スタック検知（P0件数不変）→ Tier 3: 人間エスカレーション
→ 中断報告（完了済み/中断/未着手一覧 + 決定ログパス）
```

## 7. 結合テスト仕様

<!-- /vfyで実施するテスト。要件寄りで記述。 -->

| ID | 対応要件 | テスト内容 | 期待結果 |
|----|----------|------------|----------|
| T1 | F1 | コマンド定義に仕様書パスとセクション名の入力仕様が記載されているか確認する | 仕様書パス（必須）とセクション名（省略時 "6.1"）の記述がある |
| T2 | F2 | コマンド定義にRFC一覧テーブルの抽出手順が記載されているか確認する | AIコンテキスト理解によるパース手順の記述がある |
| T3 | F3 | コマンド定義にトポロジカルソートによる依存関係解決が記載されているか確認する | 循環依存の検出・報告を含む依存解決手順の記述がある |
| T4 | F4 | コマンド定義に各RFCの直列実行フローが記載されているか確認する | 自動RFC→マージ→自動実装→マージの4ステップが記述されている |
| T5 | F5 | コマンド定義に失敗モード別のTier 2リカバリー手順が記載されているか確認する | F1〜F4の各失敗モードに対するリカバリー手順が記述されている |
| T6 | F6 | コマンド定義に決定ログの生成・追記手順が記載されているか確認する | 決定ログのファイルパス・記録項目の記述がある |
| T7 | F7-F8 | コマンド定義に完了報告と中断報告の両方の仕様が記載されているか確認する | 正常完了・途中中断の両方の報告形式が記述されている |
| T8 | N1-N2 | コマンド定義にTier 2試行回数上限とスタック検知条件が記載されているか確認する | 最大2回の試行制限と4つのスタック検知条件の記述がある |

## 8. ドキュメント編集仕様

<!-- システム概要ドキュメント等の作成・更新・削除。 -->

| 対象ファイル | 操作 | 変更内容 |
|-------------|------|----------|
| 自動開発コマンド定義 | 作成 | オーケストレーションコマンドの定義 |

システム概要ドキュメントは本リポジトリに存在しないため、更新対象はない。

## 9. Task計画

<!-- Phase/フェーズによる作業分割を禁止する。 -->
<!-- 全作業項目は単一のPRで完遂すること。 -->

| # | 種別 | 作業内容 | 依存 |
|---|------|----------|------|
| 1 | コード | 自動開発コマンド定義ファイルの新設 | - |
| 2 | テスト | 結合テスト仕様に基づく全テスト実行 | #1 |

### ロールバック基準と手順

- **基準**: コマンド実行時に既存の自動RFC・自動実装コマンドの動作に影響がある場合
- **手順**: Markdownファイル1つの追加のみであるため、`git revert` で完了する

## 10. 前提条件・依存関係

| 種別 | 内容 |
|------|------|
| コマンド依存 | 自動RFCコマンドが正常動作すること |
| コマンド依存 | 自動実装コマンドが正常動作すること |
| コマンド依存 | RFC更新・レビュー・実装修正・実装レビュー・検証の各コマンドが正常動作すること |
| ルール依存 | コマンド実行ポリシーが適用されていること（PRマージ等の自動実行に必要） |
| 前提 | 仕様書の方針レベルの承認が人間によるレビューで完了済みであること |
| 前提 | 変更対象は全てMarkdownファイルであり、外部ツール・ライブラリへの依存はない |

## 11. 詳細設計 (Detailed Design)

<!-- 箇条書き＋コード例。 -->
<!-- コードブロック間補足は2文以内の散文許可。 -->

### 11.1 コマンド定義ファイル

`adapters/claude/commands/adev.md` を新設する。

### 11.2 入力仕様

```
/adev <仕様書パス> [セクション名]
```

- 仕様書パス: 必須。RFC一覧テーブルを含む仕様書のファイルパス
- セクション名: 省略時は "6.1"。RFC一覧テーブルが記載されたセクション

### 11.3 RFC一覧テーブルの抽出

仕様書の指定セクションからRFC一覧テーブルを読み取り、各エントリの以下を抽出する。

```
エントリ構造:
- slug: RFCの識別子（例: auth-token-refresh）
- scope: スコープまたは概要
- depends_on: 依存するRFCのslugリスト（空の場合もある）
```

テーブル形式の差異（`RFC-NNN` + slug列、slugが直接識別子等）はAIのコンテキスト理解で吸収する。

### 11.4 依存関係の解決

- 依存列をパースし、有向グラフを構築する
- カーンのアルゴリズム等でトポロジカルソートを行い、実行順序を決定する
- 入次数0のノード（依存なし）から処理を開始する
- 全ノード処理前にキューが空になった場合、循環依存としてユーザに報告して終了する

### 11.5 RFC単位の実行フロー

各RFCについて以下を順次実行する。

#### ステップ1: 自動RFC（Task経由）

```
以下のコマンド定義を読み込み、その手順に従ってRFCの作成・レビューを自動実行せよ。
- コマンド定義: ~/projects/vdev/adapters/claude/commands/arfc.md

$ARGUMENTS の値は以下の元ネタ文章として扱え:
{仕様書全文 + 対象RFCのslug・スコープ・概要情報}
```

#### ステップ2: RFC PRマージ

```bash
git checkout rfc/{slug}
gh pr merge --squash --delete-branch
```

#### ステップ3: 自動実装（Task経由）

```
以下のコマンド定義を読み込み、その手順に従って実装を自動実行せよ。
- コマンド定義: ~/projects/vdev/adapters/claude/commands/aimp.md

$ARGUMENTS の値は「{slug}」として扱え。

注意: /vfy の副作用を伴う操作はユーザ承認済みとして扱え。
```

#### ステップ4: 実装PRマージ

```bash
git checkout feature/{slug}
gh pr merge --squash --delete-branch
```

#### ステップ5: 進捗サマリー出力

処理完了したRFCのslug、RFC PR URL、実装PR URLを出力する。

### 11.6 2層リカバリー + 決定ログ方式

#### Tier 1（標準リカバリー）

- 自動RFC・自動実装コマンド内部の3ラウンドレビューループ（既存、変更なし）

#### Tier 2（自動開発リカバリー）

自動RFC または自動実装コマンドが失敗で終了した場合、オーケストレータが状況を診断し、サブコマンドを直接呼び出して再試行する（RFCあたり最大2回）。

**F1: RFCレビュー不収束**

```
1. docs/rfcs/{slug}/action-plan-r{最新ラウンド}.md を読み込み、残存P0を診断
2. 修正可能と判断 → /urfc + /rrfc を直接 Task 経由で実行
3. Approve → マージへ / Request Changes → スタック検知チェック
```

**F2: Verification FAIL**

```
1. docs/rfcs/{slug}/verification-results.md を読み込み、FAIL項目を診断
2. /uimp を Task 経由で実行（FAIL項目をコンテキストとして渡す）
3. /vfy を Task 経由で再実行
4. 全PASS → レビューフェーズへ（/rimp + /uimp ループを直接実行、最大3ラウンド）
```

**F3: 実装レビュー不収束**

```
1. docs/rfcs/{slug}/action-plan-imp-r{最新ラウンド}.md を読み込み、残存P0を診断
2. /uimp + /rimp を直接 Task 経由で実行
```

**F4: PRマージ失敗**

```
1. gh pr checks でCI状況を確認、失敗ログを分析
2. 修正可能（テスト失敗、lint等）→ コード修正 + push + マージ再試行
3. 修正不可能（権限、外部サービス等）→ エスカレーション
```

#### スタック検知（Tier 2 → Tier 3 移行条件）

- リカバリー前後でP0件数が減っていない
- 同一指摘内容が2回連続で出現
- RFCあたりの Tier 2 リカバリー試行が合計2回に達した
- 権限・環境起因で解決不可能

#### Tier 3（人間エスカレーション）

- 決定ログ付きで中断報告
- 完了済み・中断・未着手のRFC一覧を提示

### 11.7 決定ログ

各RFCの処理中に `docs/rfcs/{slug}/adev-decisions.md` を生成・追記する。

```markdown
# 自動開発 決定ログ

| タイムスタンプ | フェーズ | アクション | 結果 | 備考 |
|---------------|---------|-----------|------|------|
| 2026-02-27T10:00+09:00 | RFC作成 | /arfc 実行 | 成功 | - |
| 2026-02-27T10:05+09:00 | RFCマージ | gh pr merge | 成功 | - |
| 2026-02-27T10:10+09:00 | 実装 | /aimp 実行 | 失敗 | Verification FAIL: T3 |
| 2026-02-27T10:11+09:00 | Tier2回復 | /uimp + /vfy | 成功 | FAIL項目: T3 → 修正後PASS |
```

各エントリに含める情報:
- タイムスタンプ（ISO 8601形式、JSTタイムゾーン）
- フェーズ（RFC作成、RFCマージ、実装、実装マージ、Tier2回復）
- 実行アクション
- 結果（成功/失敗）
- 備考（失敗時の診断内容・選択した対処・その理由）

### 11.8 完了報告

全RFC完了時:

```
自動開発が完了しました。

| # | slug | RFC PR | 実装PR | Status |
|---|------|--------|--------|--------|
| 1 | {slug} | {RFC PR URL} | {実装PR URL} | 完了 |
| 2 | {slug} | {RFC PR URL} | {実装PR URL} | 完了 |
```

途中中断時:

```
自動開発が中断しました。

| # | slug | Status | 備考 |
|---|------|--------|------|
| 1 | {slug} | 完了 | RFC PR: {URL}, 実装PR: {URL} |
| 2 | {slug} | 中断 | {中断理由} |
| 3 | {slug} | 未着手 | - |

決定ログ: docs/rfcs/{slug}/adev-decisions.md
```

### 単体テスト仕様

| テスト対象 | 検証観点 |
|-----------|----------|
| コマンド定義ファイル | 入力仕様（仕様書パス必須、セクション名オプション）の記述があること |
| コマンド定義ファイル | RFC一覧テーブル抽出手順の記述があること |
| コマンド定義ファイル | トポロジカルソートによる依存関係解決手順の記述があること |
| コマンド定義ファイル | 循環依存検出時のユーザ報告手順の記述があること |
| コマンド定義ファイル | 自動RFC→マージ→自動実装→マージの4ステップが記述されていること |
| コマンド定義ファイル | F1〜F4の4失敗モード別Tier 2リカバリー手順の記述があること |
| コマンド定義ファイル | スタック検知の4条件が記述されていること |
| コマンド定義ファイル | 決定ログの生成・追記手順とフォーマットの記述があること |
| コマンド定義ファイル | 完了報告・中断報告の両形式が記述されていること |
