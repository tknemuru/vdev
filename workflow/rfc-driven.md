# RFC-driven Development Workflow

## 1. 目的

コードの実装に先立ち「設計の合意」を形成することで、手戻りの最小化と技術的負債の抑制を図る。

## 2. 開発ライフサイクル

開発は以下の4ステージを経る。RFC と実装はそれぞれ独立した PR としてマージする。

### Stage 1: Drafting (RFC作成)

- **概要**: 解決すべき課題と提案する設計をドキュメント化する。
- **コマンド**: `/rfc`
- **ブランチ**: `rfc/<slug>`（デフォルトブランチから作成）
- **成果物**: `docs/rfcs/<slug>/rfc.md`
- **DoD (完了定義)**:
  - 背景、目的、具体的設計案、検証方法が記述されていること。
  - 実装に伴うトレードオフ（代替案とその比較）が示されていること。
- **完了時の状態**: `rfc/<slug>` ブランチに push 済み、Draft PR 作成済み。

### Stage 2: Reviewing (設計レビュー)

- **概要**: 3つのレビュー人格がRFCを並列レビューする。
- **コマンド**: `/rrfc`（レビュー）、`/urfc`（修正）
- **ブランチ**: `rfc/<slug>`（Stage 1 と同一）
- **成果物**: `docs/rfcs/<slug>/review-*.md`
- **DoD (完了定義)**:
  - 全レビュアーによる Approve が得られていること。
  - P0 指摘事項がすべて解決されていること。
- **完了時の状態**: RFC ステータスを「Accepted (承認済)」に更新。PR を Ready にし、人間がマージする。

### Stage 3: Implementing (実装)

- **概要**: 承認されたRFCに基づき、コードを実装する。RFC はデフォルトブランチにマージ済みの前提。
- **コマンド**: `/imp`（実装）、`/rimp`（レビュー）、`/uimp`（修正）
- **ブランチ**: `feature/<slug>`（デフォルトブランチから新規作成）
- **成果物**: 実装コード、テストコード、`docs/rfcs/<slug>/review-imp-*.md`
- **DoD (完了定義)**:
  - RFC で定義したE2Eテスト仕様をパスしていること。
  - 変更内容が RFC の設計意図と整合していること。
  - 全レビュアーによる Approve が得られていること。
- **完了時の状態**: 実装 PR が Ready 状態、人間による最終確認待ち。

### Stage 4: Closing (完了)

- **概要**: 人間が RFC PR または実装 PR を最終確認し、フィードバックがあれば対応後、マージする。
- **コマンド**: `/upr`（人間の PR コメントに基づく修正。RFC PR・実装 PR の両方に対応）
- **DoD (完了定義)**:
  - 人間の PR コメントがすべて対応済みであること。
  - 対象 PR がマージされていること。

## 3. マージ戦略

- PR のマージは **squash merge** を推奨する。
- デフォルトブランチの履歴を「1コミット = 1 PR」でクリーンに保つ。
- squash merge のコミットメッセージは、PR タイトルを使用する。

## 4. ロールバック

マージ後に問題が発見された場合:

1. **即時対応**: `git revert <merge-commit>` で変更を取り消す PR を作成し、マージする。
2. **原因調査**: revert 後、問題の原因を特定する。
3. **再実装**: 必要に応じて RFC を更新し、Stage 3 から再開する。

## 5. 運用ルール

- **No RFC, No Code**: 原則として、RFC による設計合意なしにデフォルトブランチへ向けた実装を開始してはならない。
- **Quick Fix 例外**: `/qfix` コマンドによる超軽量実装は「No RFC, No Code」原則の意図的な例外とする。会話コンテキストで既に背景・要件が合意されている軽微な変更に限定して使用すること。
- **Living Document**: 設計は実装中に変化しうる。その場合、コードだけでなく RFC も最新の状態に更新し、差異を発生させないこと。
- **Traceability**: すべての実装 PR は、対応する RFC（`docs/rfcs/<slug>/rfc.md`）へのリンクを PR body に含まなければならない。
