#!/usr/bin/env bash
set -euo pipefail

# --- 引数チェック ---
if [ $# -ne 1 ]; then
  echo "Usage: rfc-publish <slug>" >&2
  exit 1
fi

SLUG="$1"

# --- Git リポジトリ確認 ---
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)" || {
  echo "エラー: git リポジトリ内で実行してください。" >&2
  exit 1
}

# --- ブランチ確認 ---
CURRENT_BRANCH="$(git branch --show-current)"
EXPECTED_BRANCH="feature/${SLUG}"

if [ "$CURRENT_BRANCH" != "$EXPECTED_BRANCH" ]; then
  echo "エラー: 現在のブランチは ${CURRENT_BRANCH} です。${EXPECTED_BRANCH} で実行してください。" >&2
  exit 1
fi

# --- RFCファイル確認 ---
RFC_PATH="docs/rfcs/${SLUG}/rfc.md"

if [ ! -f "$REPO_ROOT/$RFC_PATH" ]; then
  echo "エラー: ${RFC_PATH} が見つかりません。" >&2
  exit 1
fi

# --- コミット & プッシュ ---
git add "$REPO_ROOT/$RFC_PATH"
git commit -m "docs: add RFC draft for ${SLUG}"
git push -u origin "$EXPECTED_BRANCH"

echo "完了: ${RFC_PATH} を ${EXPECTED_BRANCH} にプッシュしました。"
