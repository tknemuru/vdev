# /spec - サービス仕様書作成コマンド

サービス仕様書テンプレートを元に、構造化生成プロセスと
チェックリスト検証によって高品質なサービス仕様書を作成する。

## 入力情報

$ARGUMENTS

## 実行手順

### Phase 1: 入力・初期化

#### Step 1-1: プロダクト情報の取得

上記「入力情報」が空の場合は、
「プロダクトのビジョンまたは説明を入力してください。」
とだけ表示し、ユーザの次のメッセージを待て。

入力がある場合はそれをプロダクト情報として使用する。

#### Step 1-2: 不足情報ヒアリング

プロダクト情報を分析し、以下が不足・曖昧な場合は
ユーザに質問して明確化せよ:

- ターゲットユーザーの具体像
  （年齢層、居住地域、職業、利用シーン等）
- 主要ユーザー体験フロー
  （ユーザーがプロダクトを使う一連の流れ）
- 技術的制約
  （言語、フレームワーク、外部サービス、実行環境等）

十分に明確な場合はこのステップをスキップしてよい。

#### Step 1-3: テンプレートのコピー

対象リポジトリのルート（git rev-parse --show-toplevel）を
基準に、以下を実行する:

1. docs/ ディレクトリが存在しない場合は作成する
2. ~/projects/vdev/templates/service-spec/service-spec.md を
   対象リポジトリの docs/service-spec.md にコピーする
3. コピー後、テンプレートを Read ツールで読み込む

### Phase 2: 基盤セクション起草

テンプレートの各セクションを以下の順序で起草する。
先行セクションの内容を参照しながら記述すること。

1. §1 サービス概要（§1.1〜§1.4）
   - §1.1: プロダクトビジョンを一文で記述
   - §1.2: 解決する課題を列挙
   - §1.3: ターゲットユーザーを具体的に記述
   - §1.4: ユーザー体験の全体像をステップで記述

2. §5 技術アーキテクチャ
   - §5.1: 技術スタックと選定理由
   - §5.2: システム構成

3. §6 ドメイン設計
   - プロダクト固有の設計要素を記述
   - ビジネスルール・閾値定義があれば明記

4. §7 データ設計
   - §7.1: 主要エンティティ
   - §7.2: データ取得・管理戦略（該当時のみ）

5. §8 運用設計
   - §8.1: ディレクトリ構成
   - §8.2: gitignore 設計
   - §8.3: ログ設計（3要件必須）

6. §3 スコープ外要件
   - §1〜§8 の内容を踏まえ、
     明示的に対応しない要件を列挙

起草した内容を docs/service-spec.md に書き込む。

### Phase 3: E2Eテスト要件の体系的導出（§2）

本 Phase はスキップ禁止。
以下の中間ステップを必ず経由すること。

#### Step 3-1: ユーザー機能の列挙

§1.4 のユーザー体験フローから
独立したユーザー機能を列挙する。

出力形式:
| # | ユーザー機能 | 対応する §1.4 のステップ |
|---|-------------|------------------------|
| 1 | {機能名}    | {ステップ番号・内容}    |

#### Step 3-2: 条件軸の列挙

§6 のドメイン設計から、各ユーザー機能の振る舞いを
変化させる条件軸を列挙する。

出力形式:
| ユーザー機能 | 条件軸 | 値の例 | 根拠（§6 の該当箇所） |
|-------------|--------|--------|----------------------|
| {機能名}    | {軸名} | {値}   | {§6 の記述}          |

#### Step 3-3: 具体的テストデータの導出

§1.3 のターゲットユーザー情報から、
条件軸に対する具体的テストデータを導出する。

ルール:
- 汎用的なダミーデータは禁止
- ドメイン固有の実データを使用すること
- 例: ターゲットが「さいたま市在住」
  → 実在の区名・園名を使用

出力形式:
| 条件軸 | テストデータ | 導出根拠（§1.3） |
|--------|-------------|-----------------|
| {軸名} | {具体値}    | {ターゲット情報} |

#### Step 3-4: テストケース生成

Step 3-1〜3-3 を統合して §2 のテーブルを生成する。

生成ルール:
- 各ユーザー機能に対し最低2ケース
  （基本ケース + 条件変動ケース）
- §6 に閾値定義がある場合、境界値テストを含める
- 異常系を最低1ケース含める
- 全ケースに Step 3-3 の具体テストデータを使用

生成した §2 テーブルで docs/service-spec.md を更新する。

中間成果物（Step 3-1〜3-3 の表）は
仕様書末尾に以下の形式で追記する:

---
## 付録: E2Eシナリオ導出過程

### A.1 ユーザー機能一覧（Step 3-1）
{Step 3-1 の出力}

### A.2 条件軸一覧（Step 3-2）
{Step 3-2 の出力}

### A.3 具体的テストデータ（Step 3-3）
{Step 3-3 の出力}
---

### Phase 4: 開発ロードマップ（§4）

以下の順序で §4 を起草する:

1. §4.1 必要な環境情報
   - 外部サービスの認証情報等、
     人間が事前に入手すべき環境情報を列挙
   - プレースホルダー値は記載禁止

2. §4.2 事前の人間タスク
   - 開発開始前に人間が完了すべきタスクを
     チェックリスト形式で列挙

3. §4.3 RFC一覧
   - 実装を分割するRFCの slug と概要を列挙
   - 最終行は必ず「全体E2Eテスト実施」RFCとする

起草した内容で docs/service-spec.md を更新する。

### Phase 5: チェックリスト検証

同一エージェント内で実行する。
別 Task は使わない。
以下を1項目ずつ YES/NO で検証する。

#### E2Eテスト品質チェック

- [ ] §2 のケース数 ≥ Step 3-1 のユーザー機能数 × 2
- [ ] Step 3-2 の主要条件軸が §2 でカバーされている
- [ ] §1.3 のターゲット情報から導かれる
      ドメイン固有データが §2 に出現する
- [ ] §6 に閾値定義がある場合、
      その境界値テストが §2 に存在する
- [ ] 異常系テストが最低1件存在する
- [ ] 各テストケースの期待結果が
      プログラムから検証可能な形式である

#### 仕様書構造チェック

- [ ] §4.3 の最終行が
      「全体E2Eテスト実施」RFCである
- [ ] §4.1 にプレースホルダー値が含まれていない
- [ ] §8.3 がファイル出力・ローテーション・
      構造化ログの3要件を満たす
- [ ] §2 にモック・スタブ・スパイ関連用語が
      含まれていない

FAIL 項目がある場合:
1. FAIL 項目をまとめて修正する
2. 修正後に再検証する
3. 全項目 YES になるまで繰り返す

### Phase 6: チェックリスト結果サマリの出力

Phase 5 のチェックリスト結果を
以下の形式でユーザに報告する:

チェックリスト検証結果:

E2Eテスト品質:
- {項目}: {YES/NO}
- ...

仕様書構造:
- {項目}: {YES/NO}
- ...

修正回数: {N}回
最終結果: 全項目 PASS

### Phase 7: コミット & プッシュ

1. 変更ファイルをステージングする
2. コミットメッセージ:
   docs: add service spec for {プロダクト名}
3. リモートにプッシュする
4. ファイルパスをユーザに報告する
