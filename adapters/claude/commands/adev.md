# /adev - 自動開発コマンド

仕様書のRFC一覧を入力として、RFC作成から実装完了・マージまでを全自動で順次実行する。メインエージェントは薄いオーケストレータとして振る舞い、各フェーズは既存コマンド（`/arfc`, `/aimp`, `/urfc`, `/rrfc`, `/uimp`, `/rimp`, `/vfy`）を Task 経由で内部呼び出しする。

## 入力

```
/adev <仕様書パス> [セクション名]
```

$ARGUMENTS

- 仕様書パス: 必須。RFC一覧テーブルを含む仕様書のファイルパス
- セクション名: 省略時は "6.1"。RFC一覧テーブルが記載されたセクション

## 実行手順

### Step 1: 入力の取得

上記「入力」の $ARGUMENTS が空の場合は、「仕様書パスを入力してください。」とだけ表示し、ユーザの次のメッセージを待て。

$ARGUMENTS から仕様書パスとセクション名（省略時は "6.1"）を取得する。

### Step 2: 仕様書の読み込みとRFC一覧の抽出

1. 仕様書ファイルを Read ツールで読み込む。ファイルが存在しない場合はエラーを報告して終了する。
2. 指定セクション（デフォルト "6.1"）からRFC一覧テーブルを読み取り、各エントリの以下を抽出する:
   - slug: RFCの識別子
   - scope: スコープまたは概要
   - depends_on: 依存するRFCのslugリスト（空の場合もある）

テーブル形式の差異（`RFC-NNN` + slug列、slugが直接識別子等）はAIのコンテキスト理解で吸収する。

### Step 3: 依存関係の解決とトポロジカルソート

1. 各RFCエントリの depends_on をパースし、有向グラフを構築する。
2. カーンのアルゴリズムでトポロジカルソートを行い、実行順序を決定する:
   - 入次数0のノード（依存なし）から処理を開始する
   - 処理済みノードに依存するノードの入次数をデクリメントし、入次数0になったノードをキューに追加する
3. 全ノード処理前にキューが空になった場合、循環依存が存在する。循環依存に含まれるslug一覧をユーザに報告して終了する。

ソート結果（実行順序）をユーザに表示してから Step 4 に進む。

### Step 4: RFC単位の直列実行

トポロジカルソートの結果に従い、各RFCについて以下のステップ4-1〜4-5を順次実行する。

#### Step 4-1: 自動RFC（Task経由）

以下のプロンプトで Task を起動し、RFCの作成・レビューを自動実行させよ。

```
以下のコマンド定義を読み込み、その手順に従ってRFCの作成・レビューを自動実行せよ。
- コマンド定義: ~/projects/vdev/adapters/claude/commands/arfc.md

$ARGUMENTS の値は以下の元ネタ文章として扱え:
{仕様書全文 + 対象RFCのslug・スコープ・概要情報}
```

Task の結果を確認し、決定ログに記録する（Step 5 参照）。

- 成功の場合: Step 4-2 へ進む。
- 失敗の場合: Tier 2 リカバリー（Step 6）へ進む。

#### Step 4-2: RFC PRマージ

```bash
git checkout rfc/{slug}
gh pr merge --squash --delete-branch
```

マージ失敗時は Tier 2 リカバリー（Step 6、F4: PRマージ失敗）へ進む。

#### Step 4-3: 自動実装（Task経由）

以下のプロンプトで Task を起動し、実装を自動実行させよ。

```
以下のコマンド定義を読み込み、その手順に従って実装を自動実行せよ。
- コマンド定義: ~/projects/vdev/adapters/claude/commands/aimp.md

$ARGUMENTS の値は「{slug}」として扱え。

注意: /vfy の副作用を伴う操作はユーザ承認済みとして扱え。
```

Task の結果を確認し、決定ログに記録する。

- 成功の場合: Step 4-4 へ進む。
- 失敗の場合: Tier 2 リカバリー（Step 6）へ進む。

#### Step 4-4: 実装PRマージ

```bash
git checkout feature/{slug}
gh pr merge --squash --delete-branch
```

マージ失敗時は Tier 2 リカバリー（Step 6、F4: PRマージ失敗）へ進む。

#### Step 4-5: 進捗サマリー出力

処理完了したRFCのslug、RFC PR URL、実装PR URLを出力する。

```
[進捗] {現在の順番}/{全RFC数} 完了
- slug: {slug}
- RFC PR: {RFC PR URL}
- 実装PR: {実装PR URL}
```

### Step 5: 決定ログの生成・追記

各RFCの処理中に `docs/rfcs/{slug}/adev-decisions.md` を生成・追記する。Step 4 の各サブステップの開始時・完了時に以下の形式でエントリを追加せよ。

```markdown
# 自動開発 決定ログ

| タイムスタンプ | フェーズ | アクション | 結果 | 備考 |
|---------------|---------|-----------|------|------|
| 2026-02-27T10:00+09:00 | RFC作成 | /arfc 実行 | 成功 | - |
| 2026-02-27T10:05+09:00 | RFCマージ | gh pr merge | 成功 | - |
| 2026-02-27T10:10+09:00 | 実装 | /aimp 実行 | 失敗 | Verification FAIL: T3 |
| 2026-02-27T10:11+09:00 | Tier2回復 | /uimp + /vfy | 成功 | FAIL項目: T3 → 修正後PASS |
```

各エントリに含める情報:
- タイムスタンプ（ISO 8601形式、JSTタイムゾーン）
- フェーズ（RFC作成、RFCマージ、実装、実装マージ、Tier2回復）
- 実行アクション
- 結果（成功/失敗）
- 備考（失敗時の診断内容・選択した対処・その理由）

### Step 6: 2層リカバリー

自動RFC または自動実装コマンドが失敗で終了した場合、以下の失敗モード別にオーケストレータが状況を診断し、サブコマンドを直接呼び出して再試行する。RFCあたりの Tier 2 リカバリーは最大2回まで。

#### F1: RFCレビュー不収束

```
1. docs/rfcs/{slug}/action-plan-r{最新ラウンド}.md を読み込み、残存P0を診断する
2. 修正可能と判断した場合:
   - /urfc を Task 経由で実行（slug を渡す）
   - /rrfc を Task 経由で実行（slug を渡す）
3. Approve → マージ（Step 4-2）へ進む
4. Request Changes → スタック検知チェック（Step 6 末尾）へ進む
```

#### F2: Verification FAIL

```
1. docs/rfcs/{slug}/verification-results.md を読み込み、FAIL項目を診断する
2. /uimp を Task 経由で実行（slug + FAIL項目をコンテキストとして渡す）
3. /vfy を Task 経由で再実行（slug を渡す）
4. 全PASS → レビューフェーズへ（/rimp + /uimp ループを直接 Task 経由で実行、最大3ラウンド）
5. FAIL残存 → スタック検知チェックへ進む
```

#### F3: 実装レビュー不収束

```
1. docs/rfcs/{slug}/action-plan-imp-r{最新ラウンド}.md を読み込み、残存P0を診断する
2. /uimp を Task 経由で実行（slug を渡す）
3. /rimp を Task 経由で実行（slug を渡す）
4. Approve → マージ（Step 4-4）へ進む
5. Request Changes → スタック検知チェックへ進む
```

#### F4: PRマージ失敗

```
1. gh pr checks でCI状況を確認し、失敗ログを分析する
2. 修正可能（テスト失敗、lint等）→ コード修正 + git push + マージ再試行
3. 修正不可能（権限、外部サービス等）→ エスカレーション（Tier 3）
```

#### スタック検知条件（Tier 2 → Tier 3 移行）

以下のいずれかに該当した場合、Tier 3（人間エスカレーション）に移行する:

- リカバリー前後でP0件数が減っていない
- 同一指摘内容が2回連続で出現
- RFCあたりの Tier 2 リカバリー試行が合計2回に達した
- 権限・環境起因で解決不可能と判断した

### Step 7: 完了報告

#### 全RFC完了時

```
自動開発が完了しました。

| # | slug | RFC PR | 実装PR | Status |
|---|------|--------|--------|--------|
| 1 | {slug} | {RFC PR URL} | {実装PR URL} | 完了 |
| 2 | {slug} | {RFC PR URL} | {実装PR URL} | 完了 |
```

#### 途中中断時（Tier 3 エスカレーション）

```
自動開発が中断しました。

| # | slug | Status | 備考 |
|---|------|--------|------|
| 1 | {slug} | 完了 | RFC PR: {URL}, 実装PR: {URL} |
| 2 | {slug} | 中断 | {中断理由} |
| 3 | {slug} | 未着手 | - |

決定ログ: docs/rfcs/{slug}/adev-decisions.md
```
